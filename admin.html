<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFARENA Admin Panel</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        :root {
            --bg: #2c3e50;
            --sidebar-bg: #34495e;
            --card-bg: #4a617a;
            --primary-text: #ecf0f1;
            --secondary-text: #bdc3c7;
            --accent-green: #2ecc71;
            --accent-blue: #3498db;
            --accent-red: #e74c3c;
            --accent-yellow: #f1c40f;
            --accent-orange: #e67e22;
            --accent-purple: #9b59b6;
            --accent-teal: #1abc9c;
            --border: rgba(236, 240, 241, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg); color: var(--primary-text); padding: 20px; }
        
        /* --- Login Styles --- */
        #login-section {
            display: flex;
            justify-content: center;
            align-items: center;
            height: calc(100vh - 40px);
        }
        .login-container {
            background-color: var(--sidebar-bg);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .login-container h1 { margin-bottom: 20px; font-size: 1.8rem; }
        .login-container input { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 5px; border: 1px solid var(--card-bg); background: var(--bg); color: var(--primary-text); font-family: 'Poppins', sans-serif; font-size: 1rem; }
        .login-container button { width: 100%; padding: 12px; border-radius: 5px; border: none; background-color: var(--accent-blue); color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: background-color 0.3s; }
        .login-container button:hover { background-color: #2980b9; }
        #login-error { color: var(--accent-red); margin-top: 15px; min-height: 20px; display: none; }
        
        /* --- Admin Panel Styles --- */
        .admin-container { max-width: 1400px; margin: auto; }
        .admin-header { display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 20px; }
        .admin-header h1 { font-size: 1.5rem; }
        #logout-btn { margin-top: 15px; }
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-box { padding: 25px; border-radius: 10px; color: white; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .stat-box h3 { font-size: 1.2rem; margin-bottom: 5px; opacity: 0.9; }
        .stat-box .count { font-size: 3rem; font-weight: 700; }
        .stat-box#users-stat { background: linear-gradient(135deg, #2980b9, #8e44ad); }
        .stat-box#add-money-stat { background: linear-gradient(135deg, #27ae60, #16a085); }
        .stat-box#withdraw-stat { background: linear-gradient(135deg, #d35400, #c0392b); }
        .stat-box#tournaments-stat { background: linear-gradient(135deg, #f39c12, #d35400); }
        .stat-box#referral-usage-stat { background: linear-gradient(135deg, var(--accent-teal), #16a085); }
        .stat-box#coupon-usage-stat { background: linear-gradient(135deg, var(--accent-purple), #8e44ad); }
        .admin-nav { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 30px; background-color: var(--sidebar-bg); padding: 10px; border-radius: 10px; }
        .admin-nav button { background: none; border: none; color: var(--secondary-text); padding: 10px 20px; font-size: 1rem; font-weight: 500; cursor: pointer; border-radius: 8px; transition: all 0.3s ease; }
        .admin-nav button.active, .admin-nav button:hover { background-color: var(--card-bg); color: var(--primary-text); }
        .admin-section { display: none; }
        .admin-section.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .item-list { display: flex; flex-direction: column; gap: 15px; }
        .item-card { background-color: var(--card-bg); padding: 20px; border-radius: 8px; border: 1px solid var(--border); display: grid; gap: 15px; align-items: center; }
        .item-card.tournaments-card { grid-template-columns: 80px 2fr 1.5fr 1.5fr 1.5fr; }
        .item-card.transactions-card { grid-template-columns: 1.5fr 2fr 1.5fr 2.5fr; }
        .item-card.codes-card { grid-template-columns: 2fr 1fr 1fr 1fr 1fr; }
        .item-card strong { color: var(--primary-text); }
        .teams-container { grid-column: 1 / -1; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); }
        .team-box { background: var(--sidebar-bg); border-radius: 8px; margin-bottom: 15px; padding: 15px; }
        .team-box-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--card-bg); }
        .team-leader-info { font-size: 0.9rem; color: var(--secondary-text); }
        .team-player-list .player-entry { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--card-bg); }
        .team-player-list .player-entry:last-child { border-bottom: none; }
        .player-entry .gamer-tag { color: var(--primary-text); font-weight: 500; }
        .remove-gamertag-btn { background: var(--accent-red); color: white; border: none; border-radius: 50%; width: 22px; height: 22px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; }
        .thumbnail { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; }
        .btn { background-color: var(--accent-blue); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; transition: opacity 0.3s; font-size: 0.9rem; }
        .btn:hover { opacity: 0.85; }
        .btn.btn-edit { background-color: var(--accent-yellow); color: #333; }
        .btn.btn-delete { background-color: var(--accent-red); }
        .btn.btn-finish { background-color: var(--accent-orange); }
        .btn.btn-approve { background-color: var(--accent-green); }
        .btn-group { display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-start; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal { background: var(--sidebar-bg); padding: 30px; border-radius: 10px; z-index: 1001; width: 90%; max-width: 600px; box-shadow: 0 5px 25px rgba(0,0,0,0.4); max-height: 90vh; overflow-y: auto; }
        .modal h2 { margin-bottom: 20px; text-align: center; }
        .modal p { text-align: center; margin-bottom: 20px; font-size: 1.1rem; }
        .modal-form { display: flex; flex-direction: column; gap: 15px; }
        .modal-form input, .modal-form textarea, .modal-form select { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid var(--card-bg); background: var(--bg); color: var(--primary-text); font-family: 'Poppins', sans-serif;}
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    </style>
</head>
<body>

<!-- Loading Message -->
<div id="loading-message" style="text-align: center; font-size: 1.5rem; margin-top: 50px;">
    <h2>Verifying Access...</h2>
</div>

<!-- Login Section (Initially hidden) -->
<div id="login-section" style="display: none;">
    <div class="login-container">
        <h1>Admin Panel Login</h1>
        <form id="login-form">
            <input type="email" id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit">Login</button>
        </form>
        <p id="login-error"></p>
    </div>
</div>

<!-- Main Admin Panel Content (Initially hidden) -->
<div class="admin-container" id="admin-panel-content" style="display: none;">
    <div class="admin-header">
        <h1>FFARENA Admin Panel</h1>
        <button class="btn btn-delete" id="logout-btn">Logout</button>
    </div>
    <div class="dashboard-stats">
         <div class="stat-box" id="users-stat"><h3>Registered Users</h3><div class="count" id="users-count">...</div></div>
        <div class="stat-box" id="add-money-stat"><h3>Pending Add Money</h3><div class="count" id="add-money-count">...</div></div>
        <div class="stat-box" id="withdraw-stat"><h3>Pending Withdrawals</h3><div class="count" id="withdraw-count">...</div></div>
        <div class="stat-box" id="tournaments-stat"><h3>Active Tournaments</h3><div class="count" id="tournaments-count">...</div></div>
        <div class="stat-box" id="referral-usage-stat"><h3>Referral Usage</h3><div class="count" id="referral-usage-count">...</div></div>
        <div class="stat-box" id="coupon-usage-stat"><h3>Coupon Usage</h3><div class="count" id="coupon-usage-count">...</div></div>
    </div>
    <div class="admin-nav">
        <button class="nav-btn active" data-target="tournaments-section">Tournaments</button>
        <button class="nav-btn" data-target="users-section">Users</button>
        <button class="nav-btn" data-target="transactions-section">Transactions</button>
        <button class="nav-btn" data-target="referral-codes-section">Referral Codes</button>
        <button class="nav-btn" data-target="coupons-section">Coupons</button>
        <button class="nav-btn" data-target="referral-history-section">Referral History</button>
        <button class="nav-btn" data-target="coupon-history-section">Coupon History</button>
    </div>
    <main>
        <div id="tournaments-section" class="admin-section active">
            <div class="section-header"><h2>Manage Tournaments</h2><button class="btn" id="post-tournament-btn">Post New Tournament</button></div>
            <div class="item-list" id="tournament-list-admin"><p>Loading tournaments...</p></div>
        </div>
        <div id="users-section" class="admin-section">
            <div class="section-header"><h2>Manage Users</h2></div>
            <div class="item-list" id="user-list-admin"><p>Loading users...</p></div>
        </div>
        <div id="transactions-section" class="admin-section">
            <div class="section-header"><h2>Manage Transactions</h2></div>
            <div class="item-list" id="transaction-list-admin"><p>Loading transactions...</p></div>
        </div>
        <div id="referral-codes-section" class="admin-section">
            <div class="section-header"><h2>Manage Referral Codes</h2><button class="btn" id="create-referral-btn">Create New Code</button></div>
            <div class="item-list" id="referral-code-list"><p>Loading referral codes...</p></div>
        </div>
        <div id="coupons-section" class="admin-section">
            <div class="section-header"><h2>Manage Coupons</h2><button class="btn" id="create-coupon-btn">Create New Coupon</button></div>
            <div class="item-list" id="coupon-list"><p>Loading coupons...</p></div>
        </div>
        <div id="referral-history-section" class="admin-section">
            <div class="section-header"><h2>Referral Usage History</h2></div>
            <div class="item-list" id="referral-history-list"><p>Loading referral history...</p></div>
        </div>
        <div id="coupon-history-section" class="admin-section">
            <div class="section-header"><h2>Coupon Usage History</h2></div>
            <div class="item-list" id="coupon-history-list"><p>Loading coupon history...</p></div>
        </div>
    </main>
</div>

<!-- All Modals remain the same -->
<div class="modal-overlay" id="tournament-modal-overlay">
    <div class="modal" id="tournament-modal">
        <h2 id="tournament-modal-title">Post New Tournament</h2>
        <form class="modal-form" id="tournament-form">
            <input type="hidden" id="tournament-id">
            <input type="text" id="t-name" placeholder="Tournament Name" required>
            <select id="t-category" required>
                <option value="classic" selected>Classic</option>
                <option value="clash-squad">Clash Squad</option>
                <option value="lone-wolf">Lone Wolf</option>
            </select>
            <input type="url" id="t-image-url" placeholder="Image URL (e.g., https://.../image.png)">
            <input type="number" id="t-total-prize" placeholder="Total Prize Pool (৳)" required>
            <input type="number" id="t-fee" placeholder="Entry Fee (৳)" required>
            <input type="number" id="t-per-kill-bonus" placeholder="Per Kill Bonus (৳) (optional)">
            <input type="number" id="t-max-players" placeholder="Max Players" required>
            <input type="number" id="t-players-per-team" placeholder="Players per Team (e.g., 1 for Solo)" required>
            <input type="text" id="t-type" placeholder="Type (e.g., Squad, Solo)">
            <input type="text" id="t-map" placeholder="Map (e.g., Bermuda)">
            <input type="text" id="t-version" placeholder="Version (e.g., Mobile)">
            <input type="datetime-local" id="t-start-time" required>
            <textarea id="t-details" placeholder="Details & Rules" rows="4" required></textarea>
            <textarea id="t-prize-details" placeholder="Prize List (e.g., #1: 500 BDT, #2: 300 BDT)" rows="4"></textarea>
            <input type="text" id="t-room-id" placeholder="Room ID (can add later)">
            <input type="text" id="t-room-pass" placeholder="Room Password (can add later)">
            <div class="modal-actions">
                <button type="button" class="btn btn-delete" id="close-tournament-modal">Cancel</button>
                <button type="submit" class="btn btn-approve">Save Tournament</button>
            </div>
        </form>
    </div>
</div>
<div class="modal-overlay" id="referral-modal-overlay">
    <div class="modal" id="referral-modal">
        <h2>Create Referral Code</h2>
        <form class="modal-form" id="referral-form">
            <input type="text" id="referral-code" placeholder="Enter Code (e.g., WELCOME10)" required>
            <input type="number" id="referral-bonus" placeholder="Bonus Amount (৳)" required>
            <input type="number" id="referral-max-uses" placeholder="Max Uses" required>
            <div class="modal-actions">
                <button type="button" class="btn btn-delete" id="close-referral-modal">Cancel</button>
                <button type="submit" class="btn btn-approve">Save Code</button>
            </div>
        </form>
    </div>
</div>
<div class="modal-overlay" id="coupon-modal-overlay">
    <div class="modal" id="coupon-modal">
        <h2>Create Coupon</h2>
        <form class="modal-form" id="coupon-form">
            <input type="text" id="coupon-code" placeholder="Enter Coupon Code (e.g., EID20)" required>
            <input type="number" id="coupon-amount" placeholder="Amount (৳)" required>
            <input type="number" id="coupon-total-uses" placeholder="Total Uses (across all users)" required>
            <input type="number" id="coupon-per-user-limit" placeholder="Limit Per User" required>
            <div class="modal-actions">
                <button type="button" class="btn btn-delete" id="close-coupon-modal">Cancel</button>
                <button type="submit" class="btn btn-approve">Save Coupon</button>
            </div>
        </form>
    </div>
</div>
<div class="modal-overlay" id="confirmation-modal-overlay">
    <div class="modal" id="confirmation-modal">
        <h2 id="confirmation-title">Are you sure?</h2>
        <p id="confirmation-message">This action cannot be undone.</p>
        <div class="modal-actions">
            <button class="btn" id="cancel-confirmation-btn">Cancel</button>
            <button class="btn btn-delete" id="confirm-action-btn">Confirm</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="input-modal-overlay">
    <div class="modal" id="input-modal">
        <h2 id="input-title">Enter Value</h2>
        <form class="modal-form" id="input-form">
            <input type="number" id="input-field" placeholder="Amount (৳)" required>
            <div class="modal-actions">
                <button type="button" class="btn btn-delete" id="cancel-input-btn">Cancel</button>
                <button type="submit" class="btn btn-approve">Submit</button>
            </div>
        </form>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, remove, update, get, runTransaction } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCGQIUYCFzdNZfx-KIjVZ435oeKDQdSeJk",
        authDomain: "ffarena-3305a.firebaseapp.com",
        databaseURL: "https://ffarena-3305a-default-rtdb.firebaseio.com",
        projectId: "ffarena-3305a",
        storageBucket: "ffarena-3305a.firebasestorage.app",
        messagingSenderId: "285029626101",
        appId: "1:285029626101:web:c4d8702618162f254a95bc",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase();
    const auth = getAuth();

    // DOM Element References
    const loadingMessage = document.getElementById('loading-message');
    const loginSection = document.getElementById('login-section');
    const adminPanelContent = document.getElementById('admin-panel-content');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');

    // === Main Authentication Controller ===
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // User is signed in, check if they are an admin.
            const userRef = ref(db, 'users/' + user.uid);
            try {
                const snapshot = await get(userRef);
                if (snapshot.exists() && snapshot.val().isAdmin === true) {
                    // User IS an admin. Show the panel.
                    loadingMessage.style.display = 'none';
                    loginSection.style.display = 'none';
                    adminPanelContent.style.display = 'block';
                    initializeAppLogic(); // Initialize all admin panel functions
                } else {
                    // User is NOT an admin. Force logout and show login form with an error.
                    loginError.textContent = "Access Denied. Administrator privileges required.";
                    loginError.style.display = 'block';
                    await signOut(auth); // onAuthStateChanged will run again with user=null
                }
            } catch (error) {
                console.error("Error checking admin status:", error);
                await signOut(auth);
            }
        } else {
            // No user is signed in. Show the login form.
            loadingMessage.style.display = 'none';
            adminPanelContent.style.display = 'none';
            loginSection.style.display = 'flex';
        }
    });
    
    // === Login Form Submission Handler ===
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        loginError.style.display = 'none';
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        signInWithEmailAndPassword(auth, email, password)
            .catch((error) => {
                loginError.textContent = "Invalid email or password.";
                loginError.style.display = 'block';
            });
        // Note: onAuthStateChanged will handle showing the admin panel on successful login.
    });

    // This function contains ALL the logic for the admin panel.
    // It will only be called AFTER a user is verified as an admin.
    function initializeAppLogic() {
        
        // Prevent this function from running more than once
        if (window.adminPanelInitialized) return;
        window.adminPanelInitialized = true;

        // === Logout Button Functionality ===
        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth);
            // onAuthStateChanged will handle showing the login screen.
        });
        
        let usersCache = {};
        let transactionCache = { add: {}, withdraw: {}, transfers: {} };

        function loadTournamentsAdmin() {
            const tournamentListAdmin = document.getElementById('tournament-list-admin');
            onValue(ref(db, 'tournaments'), (snapshot) => {
                tournamentListAdmin.innerHTML = '';
                if (!snapshot.exists()) { tournamentListAdmin.innerHTML = '<p>No tournaments found.</p>'; return; }
                snapshot.forEach(childSnapshot => {
                    const tId = childSnapshot.key, t = childSnapshot.val();
                    if (!t) return;
                    const players = t.players || {}, playersPerTeam = t.playersPerTeam || 1, teamCount = Object.keys(players).length;
                    const joinedPlayersCount = Object.values(players).reduce((acc, team) => acc + (team && team.members ? team.members.length : 0), 0);
                    let teamsHtml = teamCount > 0 ? Object.entries(players).map(([playerId, playerData]) => {
                        if (!playerData || typeof playerData !== 'object') return '';
                        const teamLeaderUsername = usersCache[playerId]?.username || 'Unknown';
                        let playerListHtml = (Array.isArray(playerData.members) && playerData.members.length > 0) ? playerData.members.map((member, index) => {
                            const userEmail = (member && member.userId && usersCache[member.userId]) ? ` (${usersCache[member.userId].email})` : '';
                            return `<div class="player-entry"><span class="gamer-tag">${member?.gamerTag || 'N/A'}${userEmail}</span><button class="remove-gamertag-btn" data-tournament-id="${tId}" data-player-id="${playerId}" data-member-index="${index}">X</button></div>`;
                        }).join('') : '<div class="player-entry">...</div>';
                        return `<div class="team-box"><div class="team-box-header"><div><span>Leader: <strong>${teamLeaderUsername}</strong></span><br><span>Team: <strong>${playerData.teamName || 'N/A'}</strong></span></div><button class="btn btn-delete delete-team-btn" data-tournament-id="${tId}" data-player-id="${playerId}">Delete Team</button></div><div class="team-player-list">${playerListHtml}</div></div>`;
                    }).join('') : '<p>No players joined.</p>';
                    const prizeInfo = `Prize: ৳${t.totalPrize||0}<br>Fee: ৳${t.entryFee||0}<br>${t.perKillBonus ? `Per Kill: ৳${t.perKillBonus}`:''}`;
                    const imageHtml = t.imageUrl ? `<img src="${t.imageUrl}" alt="Thumb" class="thumbnail">` : `<span>No Img</span>`;
                    const categoryDisplay = (t.category || 'classic').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const card = document.createElement('div');
                    card.className = 'item-card tournaments-card';
                    card.innerHTML = `<div>${imageHtml}</div><div><strong>${t.name||'N/A'}</strong><br><span style="font-size:0.85rem;color:var(--secondary-text);">${categoryDisplay}</span></div><div>${prizeInfo}</div><div>Players: ${joinedPlayersCount}/${t.maxPlayers||'N/A'}<br>Teams: ${teamCount}/${t.maxPlayers && playersPerTeam ? Math.floor(t.maxPlayers/playersPerTeam):'N/A'}</div><div class="btn-group"><button class="btn btn-edit edit-tournament-btn" data-id="${tId}">Edit</button><button class="btn btn-finish finish-tournament-btn" data-id="${tId}">Finish</button><button class="btn btn-delete delete-refund-tournament-btn" data-id="${tId}">Delete & Refund</button></div><div class="teams-container"><strong>Joined Teams:</strong>${teamsHtml}</div>`;
                    tournamentListAdmin.appendChild(card);
                });
            });
        }
        
        function loadReferralCodesAdmin() {
            const listEl = document.getElementById('referral-code-list');
            onValue(ref(db, 'referralCodes'), (snapshot) => {
                listEl.innerHTML = '';
                if (!snapshot.exists()) { listEl.innerHTML = '<p>No referral codes.</p>'; return; }
                snapshot.forEach(childSnapshot => {
                    const codeId = childSnapshot.key, codeData = childSnapshot.val();
                    const card = document.createElement('div');
                    card.className = 'item-card codes-card';
                    card.innerHTML = `<div><strong>Code:</strong><br>${codeId}</div><div><strong>Bonus:</strong><br>৳${codeData.bonusAmount}</div><div><strong>Max Uses:</strong><br>${codeData.maxUses}</div><div><strong>Uses:</strong><br>${codeData.currentUses||0}</div><div class="btn-group"><button class="btn btn-delete delete-referral-btn" data-id="${codeId}">Delete</button></div>`;
                    listEl.appendChild(card);
                });
            });
        }

        function loadCouponsAdmin() {
            const listEl = document.getElementById('coupon-list');
            onValue(ref(db, 'coupons'), (snapshot) => {
                listEl.innerHTML = '';
                if (!snapshot.exists()) { listEl.innerHTML = '<p>No coupons.</p>'; return; }
                snapshot.forEach(childSnapshot => {
                    const codeId = childSnapshot.key, codeData = childSnapshot.val();
                    const card = document.createElement('div');
                    card.className = 'item-card codes-card';
                    card.innerHTML = `<div><strong>Code:</strong><br>${codeId}</div><div><strong>Amount:</strong><br>৳${codeData.amount}</div><div><strong>Uses:</strong><br>${codeData.currentUses||0}/${codeData.totalUses}</div><div><strong>Limit/User:</strong><br>${codeData.perUserLimit}</div><div class="btn-group"><button class="btn btn-delete delete-coupon-btn" data-id="${codeId}">Delete</button></div>`;
                    listEl.appendChild(card);
                });
            });
        }
        
        function loadReferralHistoryAdmin() {
            const listEl = document.getElementById('referral-history-list');
            onValue(ref(db, 'referralHistory'), (snapshot) => {
                listEl.innerHTML = '';
                if (!snapshot.exists()) { listEl.innerHTML = '<p>No referral history.</p>'; return; }
                let items = [];
                snapshot.forEach(cs => { items.push({ id: cs.key, ...cs.val() }); });
                items.sort((a,b) => (b.timestamp||0) - (a.timestamp||0)).forEach(data => {
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.style.gridTemplateColumns = '1.5fr 1fr 1fr 1.5fr auto';
                    card.innerHTML = `<div><strong>User:</strong><br>${data.usedByUsername||'N/A'}</div><div><strong>Code:</strong><br>${data.codeUsed}</div><div><strong>Bonus:</strong><br>৳${data.amount}</div><div><strong>Date:</strong><br>${new Date(data.timestamp).toLocaleString()}</div><div class="btn-group"><button class="btn btn-delete delete-referral-history-btn" data-id="${data.id}">Delete</button></div>`;
                    listEl.appendChild(card);
                });
            });
        }

        function loadCouponHistoryAdmin() {
            const listEl = document.getElementById('coupon-history-list');
            onValue(ref(db, 'couponHistory'), (snapshot) => {
                listEl.innerHTML = '';
                if (!snapshot.exists()) { listEl.innerHTML = '<p>No coupon history.</p>'; return; }
                let items = [];
                snapshot.forEach(cs => { items.push({ id: cs.key, ...cs.val() }); });
                items.sort((a,b) => (b.timestamp||0) - (a.timestamp||0)).forEach(data => {
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.style.gridTemplateColumns = '1.5fr 1fr 1fr 1.5fr auto';
                    card.innerHTML = `<div><strong>User:</strong><br>${usersCache[data.userId]?.username||'N/A'}</div><div><strong>Coupon:</strong><br>${data.couponCode}</div><div><strong>Amount:</strong><br>৳${data.amount}</div><div><strong>Date:</strong><br>${new Date(data.timestamp).toLocaleString()}</div><div class="btn-group"><button class="btn btn-delete delete-coupon-history-btn" data-id="${data.id}">Delete</button></div>`;
                    listEl.appendChild(card);
                });
            });
        }
        
        document.getElementById('tournament-form').addEventListener('submit', async (e) => { e.preventDefault(); const tId=document.getElementById('tournament-id').value; const data={name:document.getElementById('t-name').value,category:document.getElementById('t-category').value,imageUrl:document.getElementById('t-image-url').value.trim(),totalPrize:parseInt(document.getElementById('t-total-prize').value),entryFee:parseInt(document.getElementById('t-fee').value),maxPlayers:parseInt(document.getElementById('t-max-players').value),playersPerTeam:parseInt(document.getElementById('t-players-per-team').value),type:document.getElementById('t-type').value.trim(),map:document.getElementById('t-map').value.trim(),version:document.getElementById('t-version').value.trim(),startTime:document.getElementById('t-start-time').value,detailsAndRules:document.getElementById('t-details').value,prizeDetails:document.getElementById('t-prize-details').value,roomID:document.getElementById('t-room-id').value.trim(),roomPass:document.getElementById('t-room-pass').value.trim()}; const pkB=document.getElementById('t-per-kill-bonus').value; if(pkB&&!isNaN(parseInt(pkB)))data.perKillBonus=parseInt(pkB); const tRef=tId?ref(db,`tournaments/${tId}`):push(ref(db,'tournaments')); if(tId){await update(tRef,data);}else{await set(tRef,data);} document.getElementById('tournament-modal-overlay').style.display='none'; });
        document.getElementById('referral-form').addEventListener('submit', async (e) => { e.preventDefault(); const code=document.getElementById('referral-code').value.trim(),bonus=parseInt(document.getElementById('referral-bonus').value),maxUses=parseInt(document.getElementById('referral-max-uses').value); if(!code||isNaN(bonus)||isNaN(maxUses))return; await set(ref(db,`referralCodes/${code}`),{bonusAmount:bonus,maxUses:maxUses,currentUses:0}); document.getElementById('referral-modal-overlay').style.display='none'; });
        document.getElementById('coupon-form').addEventListener('submit', async (e) => { e.preventDefault(); const code=document.getElementById('coupon-code').value.trim(),amount=parseInt(document.getElementById('coupon-amount').value),totalUses=parseInt(document.getElementById('coupon-total-uses').value),perUserLimit=parseInt(document.getElementById('coupon-per-user-limit').value); if(!code||isNaN(amount)||isNaN(totalUses)||isNaN(perUserLimit))return; await set(ref(db,`coupons/${code}`),{amount:amount,totalUses:totalUses,perUserLimit:perUserLimit,currentUses:0,users:{}}); document.getElementById('coupon-modal-overlay').style.display='none'; });
        document.addEventListener('click', async (e) => { const t=e.target; if(t.classList.contains('edit-tournament-btn')){ const s=await get(ref(db,`tournaments/${t.dataset.id}`)); if(!s.exists())return; const d=s.val(); document.getElementById('tournament-id').value=t.dataset.id; document.getElementById('t-name').value=d.name||''; document.getElementById('t-category').value=d.category||'classic'; document.getElementById('t-image-url').value=d.imageUrl||''; document.getElementById('t-total-prize').value=d.totalPrize||''; document.getElementById('t-fee').value=d.entryFee||''; document.getElementById('t-per-kill-bonus').value=d.perKillBonus||''; document.getElementById('t-max-players').value=d.maxPlayers||''; document.getElementById('t-players-per-team').value=d.playersPerTeam||''; document.getElementById('t-type').value=d.type||''; document.getElementById('t-map').value=d.map||''; document.getElementById('t-version').value=d.version||''; document.getElementById('t-start-time').value=d.startTime||''; document.getElementById('t-details').value=d.detailsAndRules||''; document.getElementById('t-prize-details').value=d.prizeDetails||''; document.getElementById('t-room-id').value=d.roomID||''; document.getElementById('t-room-pass').value=d.roomPass||''; document.getElementById('tournament-modal-title').textContent='Edit Tournament'; document.getElementById('tournament-modal-overlay').style.display='flex'; } if(t.classList.contains('finish-tournament-btn')){modalLogic.showConfirmationModal('Finish Tournament','This will remove the tournament permanently.',()=>remove(ref(db,`tournaments/${t.dataset.id}`)))} if(t.classList.contains('delete-refund-tournament-btn')){const id=t.dataset.id;modalLogic.showConfirmationModal('Delete & Refund All','This will refund all teams and delete the tournament.',async()=>{const s=await get(ref(db,`tournaments/${id}`));if(!s.exists())return; const d=s.val();if(d.players&&d.entryFee>0){const fee=d.entryFee;for(const[pId,tData]of Object.entries(d.players)){const count=Array.isArray(tData.members)?tData.members.length:0;if(count>0){await runTransaction(ref(db,`users/${pId}/balance`),(bal)=>(bal||0)+fee*count);}}}await remove(ref(db,`tournaments/${id}`));})} if(t.classList.contains('delete-team-btn')){const{tournamentId,playerId}=t.dataset;modalLogic.showConfirmationModal('Delete Team','Remove team without refund?',()=>remove(ref(db,`tournaments/${tournamentId}/players/${playerId}`)))} if(t.classList.contains('remove-gamertag-btn')){const{tournamentId,playerId,memberIndex}=t.dataset;modalLogic.showConfirmationModal('Remove Player','Remove player without refund?',async()=>{const pRef=ref(db,`tournaments/${tournamentId}/players/${playerId}`),pSnap=await get(pRef);if(!pSnap.exists())return; let data=pSnap.val(),members=data.members||[];if(Array.isArray(members)&&members.length>parseInt(memberIndex)){members.splice(parseInt(memberIndex),1);if(members.length===0){await remove(pRef);}else{await update(pRef,{members:members});}}})} if(t.classList.contains('delete-referral-btn')){modalLogic.showConfirmationModal('Delete Code','Are you sure?',()=>remove(ref(db,`referralCodes/${t.dataset.id}`)))} if(t.classList.contains('delete-coupon-btn')){modalLogic.showConfirmationModal('Delete Coupon','Are you sure?',()=>remove(ref(db,`coupons/${t.dataset.id}`)))} if(t.classList.contains('delete-referral-history-btn')){modalLogic.showConfirmationModal('Delete Record','Are you sure?',()=>remove(ref(db,`referralHistory/${t.dataset.id}`)))} if(t.classList.contains('delete-coupon-history-btn')){modalLogic.showConfirmationModal('Delete Record','Are you sure?',()=>remove(ref(db,`couponHistory/${t.dataset.id}`)))} if(t.classList.contains('user-money-btn')){const id=t.dataset.id,action=t.dataset.action;modalLogic.showInputModal(`Enter amount to ${action}`,async(amt)=>{if(amt<=0)return;await runTransaction(ref(db,`users/${id}/balance`),(bal)=>(bal||0)+(action==='add'?amt:-amt));})} if(t.classList.contains('delete-user-btn')){modalLogic.showConfirmationModal('Delete User','Remove user profile?',()=>remove(ref(db,`users/${t.dataset.id}`)))} const{reqId,userId,amount,type}=t.dataset; if(t.classList.contains('approve-request-btn')){if(type==='Add Money')await runTransaction(ref(db,`users/${userId}/balance`),(bal)=>(bal||0)+parseInt(amount));const path=type==='Add Money'?'addMoneyRequests':'withdrawRequests';update(ref(db,`${path}/${reqId}`),{status:'Approved'});} if(t.classList.contains('reject-request-btn')){modalLogic.showConfirmationModal('Reject Request','Are you sure?',async()=>{if(type==='Withdraw')await runTransaction(ref(db,`users/${userId}/balance`),(bal)=>(bal||0)+parseInt(amount));const path=type==='Add Money'?'addMoneyRequests':'withdrawRequests';update(ref(db,`${path}/${reqId}`),{status:'Rejected'});})} if(t.classList.contains('delete-request-btn')){let path;if(type==='Add Money')path='addMoneyRequests';else if(type==='Withdraw')path='withdrawRequests';else if(type==='Transfer')path='transfers';if(path)modalLogic.showConfirmationModal('Delete Request','Delete record?',()=>remove(ref(db,`${path}/${reqId}`)));} });
        const modalLogic=(()=>{const cM=document.getElementById('confirmation-modal-overlay'),iM=document.getElementById('input-modal-overlay');let cCb=null,iCb=null;function showC(t,m,oC){cM.querySelector('h2').textContent=t;cM.querySelector('p').textContent=m;cCb=oC;cM.style.display='flex';}function showI(t,oC){iM.querySelector('h2').textContent=t;iM.querySelector('input').value='';iCb=oC;iM.style.display='flex';}function hide(){cM.style.display='none';iM.style.display='none';}document.getElementById('confirm-action-btn').onclick=()=>{if(cCb)cCb();hide();};document.getElementById('input-form').onsubmit=(e)=>{e.preventDefault();const v=parseInt(document.getElementById('input-field').value);if(iCb&&!isNaN(v))iCb(v);hide();};document.getElementById('cancel-confirmation-btn').onclick=hide;document.getElementById('cancel-input-btn').onclick=hide;return{showConfirmationModal:showC,showInputModal:showI};})();
        const navButtons=document.querySelectorAll('.nav-btn'),sections=document.querySelectorAll('.admin-section');
        navButtons.forEach(btn=>btn.addEventListener('click',()=>{navButtons.forEach(b=>b.classList.remove('active'));btn.classList.add('active');sections.forEach(sec=>sec.classList.toggle('active',sec.id===btn.dataset.target));}));
        function loadDashboardStats(){onValue(ref(db,'users'),s=>document.getElementById('users-count').textContent=s.exists()?s.size:0);onValue(ref(db,'tournaments'),s=>document.getElementById('tournaments-count').textContent=s.exists()?s.size:0);onValue(ref(db,'referralHistory'),s=>document.getElementById('referral-usage-count').textContent=s.exists()?s.size:0);onValue(ref(db,'couponHistory'),s=>document.getElementById('coupon-usage-count').textContent=s.exists()?s.size:0);onValue(ref(db,'addMoneyRequests'),s=>{let c=0;if(s.exists()){s.forEach(cs=>{if(cs.val().status==='Pending')c++;});}document.getElementById('add-money-count').textContent=c;});onValue(ref(db,'withdrawRequests'),s=>{let c=0;if(s.exists()){s.forEach(cs=>{if(cs.val().status==='Pending')c++;});}document.getElementById('withdraw-count').textContent=c;});}
        function loadUsersAdmin(){const el=document.getElementById('user-list-admin');onValue(ref(db,'users'),s=>{el.innerHTML='';if(!s.exists()){el.innerHTML='<p>No users.</p>';return;}s.forEach(cs=>{const id=cs.key,u=cs.val();const card=document.createElement('div');card.className='item-card';card.style.gridTemplateColumns='2fr 1.5fr 1.5fr 1fr';card.innerHTML=`<div><strong>${u.username}</strong><br><span style="font-size:0.85rem;color:var(--secondary-text);">${u.email}</span></div><div>Balance: ৳${(u.balance||0).toFixed(2)}</div><div class="btn-group"><button class="btn btn-edit user-money-btn" data-id="${id}" data-action="add">Add</button><button class="btn btn-delete user-money-btn" data-id="${id}" data-action="remove">Remove</button></div><div class="btn-group"><button class="btn btn-delete delete-user-btn" data-id="${id}">Delete</button></div>`;el.appendChild(card);});});}
        function renderAllTransactions(){const el=document.getElementById('transaction-list-admin');el.innerHTML='';let all=[...Object.entries(transactionCache.add).map(([id,data])=>({id,type:'Add Money',...data})),...Object.entries(transactionCache.withdraw).map(([id,data])=>({id,type:'Withdraw',...data})),...Object.entries(transactionCache.transfers).map(([id,data])=>({id,type:'Transfer',...data}))];all.sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));if(all.length===0){el.innerHTML='<p>No transactions.</p>';return;}for(const req of all){let uD='',st='',act='',amt=`৳${req.amount||0}`;if(req.type==='Add Money'||req.type==='Withdraw'){const user=usersCache[req.userId];let dL='';if(req.type==='Add Money'){dL=`TrxID: ${req.transactionId||'N/A'}`;}else if(req.type==='Withdraw'){dL=`Number: ${req.number||'N/A'}`;}uD=`User: ${user?user.username:'N/A'}<br><span style="font-size:0.85rem;color:var(--secondary-text);">Method: <strong>${req.method||'N/A'}</strong> | ${dL}</span>`;st=`Status: ${req.status||'N/A'}`;if(req.status==='Pending'){act=`<button class="btn btn-approve approve-request-btn" data-req-id="${req.id}" data-user-id="${req.userId}" data-amount="${req.amount}" data-type="${req.type}">Approve</button> <button class="btn btn-delete reject-request-btn" data-req-id="${req.id}" data-user-id="${req.userId}" data-amount="${req.amount}" data-type="${req.type}">Reject</button>`;}act+=`<button class="btn btn-delete delete-request-btn" data-req-id="${req.id}" data-type="${req.type}">Delete</button>`;}else if(req.type==='Transfer'){uD=`Sender: ${req.senderUsername||'N/A'}<br>Recipient: ${req.recipientUsername||'N/A'}`;st=`Status: ${req.status||'Completed'}`;act=`<button class="btn btn-delete delete-request-btn" data-req-id="${req.id}" data-type="${req.type}">Delete</button>`;}const card=document.createElement('div');card.className='item-card transactions-card';card.innerHTML=`<div><strong>${req.type}</strong><br>${amt}</div><div>${uD}</div><div>${st}</div><div class="btn-group">${act}</div>`;el.appendChild(card);}}
        function initializeRealtimeListeners(){onValue(ref(db,'users'),s=>{usersCache=s.exists()?s.val():{};if(document.querySelector('.admin-section.active')?.id==='tournaments-section'){loadTournamentsAdmin();}if(document.querySelector('.admin-section.active')?.id==='coupon-history-section'){loadCouponHistoryAdmin();}renderAllTransactions();});onValue(ref(db,'addMoneyRequests'),s=>{transactionCache.add=s.exists()?s.val():{};renderAllTransactions();});onValue(ref(db,'withdrawRequests'),s=>{transactionCache.withdraw=s.exists()?s.val():{};renderAllTransactions();});onValue(ref(db,'transfers'),s=>{transactionCache.transfers=s.exists()?s.val():{};renderAllTransactions();});}
        document.getElementById('post-tournament-btn').addEventListener('click',()=>{document.getElementById('tournament-form').reset();document.getElementById('tournament-id').value='';document.getElementById('tournament-modal-title').textContent='Post New Tournament';document.getElementById('tournament-modal-overlay').style.display='flex';});
        document.getElementById('close-tournament-modal').addEventListener('click',()=>{document.getElementById('tournament-modal-overlay').style.display='none'});
        document.getElementById('create-referral-btn').addEventListener('click',()=>{document.getElementById('referral-form').reset();document.getElementById('referral-modal-overlay').style.display='flex';});
        document.getElementById('close-referral-modal').addEventListener('click',()=>{document.getElementById('referral-modal-overlay').style.display='none'});
        document.getElementById('create-coupon-btn').addEventListener('click',()=>{document.getElementById('coupon-form').reset();document.getElementById('coupon-modal-overlay').style.display='flex';});
        document.getElementById('close-coupon-modal').addEventListener('click',()=>{document.getElementById('coupon-modal-overlay').style.display='none'});
        
        loadDashboardStats();
        loadTournamentsAdmin();
        loadUsersAdmin();
        loadReferralCodesAdmin();
        loadCouponsAdmin();
        loadReferralHistoryAdmin();
        loadCouponHistoryAdmin();
        initializeRealtimeListeners(); 
    }
</script>
</body>
</html>
