<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFARENA</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        :root {
            --bg-color: #1a1a2e;
            --card-bg: #16213e;
            --input-bg: #1a1a2e;
            --primary-text: #ffffff;
            --secondary-text: #e0e0e0;
            --accent-color: #e94560;
            --success-color: #00c853;
            --info-color: #0f3460;
            --transfer-color: #5f27cd;
            --error-color: #ff3d00;
            --border-color: #0f3460;
            --prize-list-bg: #101c32;
            --premium-orange: #e67e22;
            --yellow-accent: #f1c40f;
            --ripple-color: rgba(255, 255, 255, 0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: 100%; }
        body {
            font-family: 'Poppins', sans-serif;
            color: var(--primary-text);
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            overflow: hidden;
            padding: 20px 0;
        }
        .container {
            width: 100%;
            max-width: 420px;
            height: 100%;
            background-color: var(--bg-color);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        #auth-section, #app-section {
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }
        #auth-section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            justify-content: center;
        }
        #app-section.active, #auth-section.active { display: flex; }
        .scrollable-content {
            flex-grow: 1;
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            scroll-behavior: smooth;
            padding: 0 15px;
        }
        .scrollable-content::-webkit-scrollbar { display: none; }
        .app-title { font-size: 2.2rem; font-weight: 700; margin-bottom: 30px; text-align: center; color: var(--primary-text); }
        .page-title { font-size: 2rem; font-weight: 700; margin: 20px 0; text-align: center; color: var(--accent-color); }

        .section {
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }
        .section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 380px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .content-card { background: var(--card-bg); border-radius: 15px; padding: 25px; margin-bottom: 20px; }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .app-logo img {
            height: 40px;
        }
        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .wallet-balance {
            display: flex;
            align-items: center;
            background-color: var(--premium-orange);
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            color: #fff;
        }
        .wallet-balance svg {
            width: 20px;
            height: 20px;
            margin-right: 5px;
            fill: #fff;
        }
        .profile-menu-btn {
            background: none;
            border: 2px solid var(--secondary-text);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: var(--secondary-text);
        }
        .profile-menu-btn svg {
             width: 24px;
             height: 24px;
             fill: currentColor;
        }

        #side-menu-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #side-menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        #side-menu {
            position: absolute;
            top: 0;
            right: -280px;
            width: 280px;
            height: 100%;
            background-color: var(--card-bg);
            z-index: 2000;
            transition: right 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        #side-menu.active {
            right: 0;
        }
        .side-menu-header { padding: 20px; background-color: var(--info-color); text-align: center; position: relative; }
        .side-menu-header .close-menu-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; }
        .side-menu-header .settings-btn {
            position: absolute; top: 10px; right: 45px;
            background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;
            width: 30px; height: 30px; display: flex; justify-content: center; align-items: center;
        }
        .side-menu-header .settings-btn svg { width: 20px; height: 20px; fill: currentColor; }
        .side-menu-header .user-icon { width: 50px; height: 50px; border-radius: 50%; background: var(--secondary-text); color: var(--info-color); display: flex; justify-content: center; align-items: center; margin: 0 auto 10px; }
        .side-menu-header .user-icon svg { width: 30px; height: 30px; fill: currentColor; }
        .side-menu-header h3 { font-size: 1.1rem; margin: 0; }
        .side-menu-header p { font-size: 0.8rem; color: var(--secondary-text); margin: 0;}
        .side-menu-nav { flex-grow: 1; overflow-y: auto; padding: 15px 0; }
        .side-menu-nav a { display: flex; align-items: center; gap: 15px; padding: 12px 20px; color: var(--secondary-text); text-decoration: none; font-size: 1rem; font-weight: 500; }
        .side-menu-nav a:hover, .side-menu-nav a.active { background-color: rgba(233, 69, 96, 0.1); color: var(--accent-color); border-right: 3px solid var(--accent-color); }
        .side-menu-nav a svg { width: 22px; height: 22px; fill: currentColor; }


        #profile-section {
            background: var(--bg-color);
            padding-top: 30px;
        }
        #profile-section .page-title { display: none; }
        .profile-v2-container { text-align: center; }
        .profile-v2-pic-wrapper {
            position: relative;
            width: 130px;
            height: 130px;
            margin: 0 auto 15px auto;
        }
        #profile-v2-pic {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            border: 3px solid var(--info-color);
        }
        #profile-pic-upload-label {
            position: absolute;
            bottom: 5px; right: 5px;
            background-color: var(--accent-color);
            color: var(--bg-color);
            width: 35px; height: 35px;
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            border: 2px solid var(--card-bg);
        }
        #profile-pic-upload { display: none; }

        .profile-v2-username-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
        }
        .profile-v2-username {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary-text);
        }
        .verified-badge {
            display: flex;
            align-items: center;
            gap: 5px;
            background-color: rgba(241, 196, 15, 0.1);
            border: 1px solid var(--yellow-accent);
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--yellow-accent);
        }
        .verified-badge img { height: 16px; }

        .profile-v2-details-card, .profile-v2-stats-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin: 0 15px 20px 15px;
            text-align: left;
        }
        .profile-v2-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1rem;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .profile-v2-detail-item:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .profile-v2-detail-item .label { color: var(--secondary-text); }
        .profile-v2-detail-item .value { color: var(--primary-text); font-weight: 500; }
        .profile-v2-detail-item .value.active { color: var(--success-color); font-weight: 600; }
         .profile-v2-stats-card {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        .profile-v2-stat .label { font-size: 0.9rem; color: var(--secondary-text); margin-bottom: 5px; }
        .profile-v2-stat .value { font-size: 1.5rem; font-weight: 600; color: var(--yellow-accent); }
        #profile-v2-logout-btn { display: block; width: calc(100% - 30px); margin: 20px auto; background-color: var(--yellow-accent); color: var(--bg-color); font-size: 1.1rem; }
        
        .support-card { background-color: var(--card-bg); border-radius: 15px; padding: 20px; margin-bottom: 25px; }
        .support-card h3 { font-size: 1.5rem; margin-bottom: 20px; text-align: center; color: var(--primary-text); }
        .follow-us-item, .contact-us-item { display: flex; align-items: center; background-color: var(--input-bg); padding: 15px; border-radius: 10px; margin-bottom: 15px; text-decoration: none; color: var(--secondary-text); transition: background-color 0.3s; }
        .follow-us-item:hover { background-color: var(--info-color); }
        .follow-us-item svg { width: 28px; height: 28px; margin-right: 15px; }
        .follow-us-item .telegram { fill: #2AABEE; }
        .follow-us-item .youtube { fill: #FF0000; }
        .follow-us-item .facebook { fill: #1877F2; }
        .contact-us-item p { margin: 0; display: flex; flex-direction: column; }
        .contact-us-item strong { color: var(--primary-text); font-size: 1rem; }

        #tournament-category-selection { padding-top: 20px; }
        .category-selection-card { height: 150px; border-radius: 15px; margin-bottom: 20px; position: relative; overflow: hidden; display: flex; align-items: center; padding: 20px; cursor: pointer; background-size: cover; background-position: center; transition: transform 0.3s ease; gap: 20px; }
        .category-selection-card:active { transform: scale(0.97); }
        .category-selection-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to right, rgba(0,0,0,0.8), rgba(0,0,0,0.1)); border-radius: 15px; }
        .category-selection-card .content { position: relative; z-index: 2; }
        .category-selection-card h3 { font-size: 1.8rem; font-weight: 700; color: var(--primary-text); margin: 0; text-shadow: 2px 2px 5px rgba(0,0,0,0.7); }
        .category-selection-card p { font-size: 1rem; color: var(--secondary-text); margin: 5px 0 0; font-weight: 500; text-shadow: 1px 1px 3px rgba(0,0,0,0.6); }
        .category-icon { position: relative; z-index: 2; width: 60px; height: 60px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.8); object-fit: cover; }
        #back-to-categories-btn { display: none; margin: 0 auto 20px; width: 200px; background-color: var(--info-color); }
        
        .tournament-category { display: none; }
        .tournament-category.active { display: block; }
        .new-tournament-card { background-color: var(--card-bg); border-radius: 15px; margin-bottom: 20px; overflow: hidden; border: 1px solid var(--premium-orange); transition: transform 0.2s ease-in-out; }
        .card-header { display: flex; align-items: center; padding: 15px; background-color: rgba(0,0,0,0.2); cursor: pointer; }
        .card-header img { width: 45px; height: 45px; border-radius: 8px; margin-right: 15px; }
        .card-header-title { flex-grow: 1; }
        .card-header-title h3 { font-size: 1.2rem; margin: 0; color: var(--primary-text); }
        .card-header-title p { font-size: 0.85rem; color: var(--secondary-text); margin: 0; }
        .card-body { padding: 15px; }
        .details-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center; margin-bottom: 15px; }
        .detail-item p { margin: 0; font-size: 0.8rem; color: var(--secondary-text); }
        .detail-item span { font-size: 1.1rem; font-weight: 600; color: var(--primary-text); }
        .sub-details-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center; margin-bottom: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .player-progress-section { display: flex; align-items: center; gap: 10px; margin: 15px 0; cursor: pointer; }
        .progress-bar-container { flex-grow: 1; height: 10px; background-color: var(--input-bg); border-radius: 10px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background-color: var(--accent-color); border-radius: 10px; }
        .player-count { font-size: 0.9rem; color: var(--secondary-text); white-space: nowrap;}
        .card-footer { display: flex; justify-content: space-between; align-items: center; padding: 0 15px 15px; gap: 10px; }
        .countdown { font-size: 0.9rem; font-weight: 500; text-align: center; color: var(--secondary-text); margin-bottom: 15px; }
        .match-started-text { color: var(--success-color); font-weight: 600; text-align: center; margin-bottom: 15px;}
        .prize-list-details { display: none; background-color: var(--prize-list-bg); padding: 15px; margin: 0 15px 15px; border-radius: 8px; white-space: pre-wrap; }
        .prize-list-details p { margin: 5px 0; color: var(--secondary-text); }
        .prize-list-details strong { color: var(--primary-text); }
        
        .form-switch { display: flex; justify-content: center; margin-bottom: 25px; background: var(--input-bg); border-radius: 10px; padding: 5px; }
        .form-switch button { flex: 1; background: transparent; border: none; color: var(--secondary-text); font-size: 1rem; font-weight: 500; cursor: pointer; padding: 10px; border-radius: 8px; transition: all 0.3s ease; }
        .form-switch button.active { background: var(--accent-color); color: var(--primary-text); font-weight: 600; box-shadow: 0 0 15px rgba(233, 69, 96, 0.5); }
        
        .form-container { display: none; } .form-container.active { display: block; }
        .form-field { margin-bottom: 18px; position: relative; }
        .form-field input { width: 100%; padding: 14px 15px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--primary-text); font-size: 0.95rem; }
        .modal .form-field label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--secondary-text); }
        
        .auth-actions { text-align: right; margin-top: -10px; margin-bottom: 20px;}
        .auth-actions a { color: var(--secondary-text); font-size: 0.9rem; text-decoration: none; }
        .auth-actions a:hover { color: var(--accent-color); }

        .btn { padding: 12px 20px; color: var(--primary-text); border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: transform 0.1s ease, background-color 0.3s ease; text-align: center; }
        .btn:active { transform: scale(0.96); }
        .btn:disabled { background-color: #5a6268; cursor: not-allowed; }
        .btn.btn-primary { background-color: var(--accent-color); width: 100%;}
        .btn.btn-danger { background-color: var(--error-color); width: 100%;}
        .btn.btn-success { background-color: var(--success-color); flex-grow: 1; }
        .btn.btn-info { background-color: var(--info-color); flex-grow: 1;}
        .btn.btn-special { background-color: var(--transfer-color); width: 100%;}
        
        .modal .modal-body { max-height: 60vh; overflow-y: auto; padding-right: 10px; }
        .modal-header { text-align: center; color: var(--accent-color); font-size: 1.5rem; font-weight: 600; margin-bottom: 20px; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-actions .cancel { background-color: #6c757d; }
        .details-modal-section { margin-bottom: 20px; }
        .details-modal-section h4 { color: var(--accent-color); margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .details-modal-section p { margin-bottom: 8px; color: var(--secondary-text); }
        .details-modal-section strong { color: var(--primary-text); }
        .message { padding: 12px 15px; margin-bottom: 15px; border-radius: 8px; text-align: center; display: none; font-weight: 500; }
        .message.success-message { background-color: var(--success-color); color: white; }
        .message.error-message { background-color: var(--error-color); color: white; }
        .transaction-item { display: flex; justify-content: space-between; align-items: center; background: var(--input-bg); padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .transaction-info p { margin: 0; }
        .transaction-info .type { font-weight: 600; font-size: 1rem; }
        .transaction-info .date { font-size: 0.8rem; color: var(--secondary-text); }
        .transaction-amount { font-weight: 600; padding: 5px 10px; border-radius: 20px; font-size: 0.9rem; }
        .transaction-amount.Credit { background-color: var(--success-color); color: #fff; }
        .transaction-amount.Debit { background-color: var(--error-color); color: #fff; }
        .transaction-amount.Pending { background-color: #ffab00; color: #000;}
        .transaction-amount.Rejected { background-color: var(--error-color); color: white; }
        .team-view-card { background-color: var(--input-bg); padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid var(--premium-orange); }
        .team-view-card h4 { color: var(--primary-text); font-size: 1.2rem; margin-bottom: 10px; }
        .team-view-card .slot-count { color: var(--secondary-text); font-size: 0.9rem; margin-bottom: 12px; }
        .team-view-card .gamertag-list { list-style: none; padding-left: 0; margin-bottom: 15px; }
        .team-view-card .gamertag-list li { background: var(--bg-color); padding: 8px 12px; border-radius: 6px; margin-bottom: 5px; color: var(--primary-text); }
        .team-view-card .btn.join-existing-team-btn { width: 100%; background-color: var(--success-color); margin-top: 10px; }
        .player-input-group { background: var(--card-bg); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border-color); }
        .ripple-effect { position: relative; overflow: hidden; }
        .ripple { position: absolute; border-radius: 50%; background-color: var(--ripple-color); transform: scale(0); animation: ripple-animation 0.6s linear; pointer-events: none; }
        @keyframes ripple-animation { to { transform: scale(4); opacity: 0; } }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-section" class="active">
        <h1 class="app-title" id="auth-title">FFARENA LOGIN</h1>
        <div class="form-switch"> <button id="show-login-btn" class="active ripple-effect">Login</button> <button id="show-register-btn" class="ripple-effect">Register</button> </div>
        <div id="login-form" class="form-container active">
            <form onsubmit="return false;">
                <div class="form-field"> <input type="email" id="login-email" placeholder="Email" required> </div>
                <div class="form-field"> <input type="password" id="login-password" placeholder="Password" required> </div>
                <div class="auth-actions">
                    <a href="#" id="forgot-password-link">Forgot Password?</a>
                </div>
                <button id="login-btn" class="btn btn-primary ripple-effect">Login</button>
            </form>
        </div>
        <div id="register-form" class="form-container">
             <form onsubmit="return false;">
                <div class="form-field"> <input type="text" id="register-username" placeholder="Username" required> </div>
                <div class="form-field"> <input type="email" id="register-email" placeholder="Email" required> </div>
                <div class="form-field"> <input type="tel" id="register-phone" placeholder="Phone Number" required> </div>
                <div class="form-field"> <input type="password" id="register-password" placeholder="Password" required> </div>
                <div class="form-field"> <input type="number" id="register-pin" placeholder="4-Digit Support PIN" maxlength="4" required> </div>
                <button id="register-btn" class="btn btn-primary ripple-effect">Register</button>
             </form>
        </div>
        <div id="auth-error" class="message error-message"></div>
    </div>

    <div id="app-section">
         <div class="app-header">
             <a class="app-logo" href="#" id="home-logo-link"><img src="https://i.ibb.co/pvYBPyvf/file-0000000053bc61f7a639378a5d28fa24.png" alt="FFARENA Logo"></a>
             <div class="header-actions">
                 <div class="wallet-balance">
                     <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>
                     <span id="header-balance">0.00</span> BDT
                 </div>
                 <button class="profile-menu-btn ripple-effect" id="profile-menu-btn">
                     <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                 </button>
             </div>
         </div>
         <div class="scrollable-content">
            <div id="profile-section" class="section">
                <div class="profile-v2-container">
                    <div class="profile-v2-pic-wrapper">
                         <img id="profile-v2-pic" src="https://i.ibb.co/6yT4R45/default-avatar.png" alt="Profile">
                         <label for="profile-pic-upload" id="profile-pic-upload-label" class="ripple-effect"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 24 24" width="20" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg></label>
                         <input type="file" id="profile-pic-upload" accept="image/*">
                    </div>
                    <div class="profile-v2-username-wrapper">
                        <h2 id="profile-v2-username" class="profile-v2-username">automation</h2>
                        <div class="verified-badge">
                           <img src="https://i.ibb.co/5dcDCkV/1000049476-removebg-preview.png" alt="V"> Verified
                        </div>
                    </div>
                    <div id="profile-info-success" class="message success-message"></div>
                    <div class="profile-v2-details-card">
                        <div class="profile-v2-detail-item">
                            <span class="label">Balance</span>
                            <span id="profile-v2-balance" class="value">0.00 BDT</span>
                        </div>
                        <div class="profile-v2-detail-item">
                            <span class="label">Status</span>
                            <span class="value active">Active</span>
                        </div>
                        <div class="profile-v2-detail-item">
                            <span class="label">Email</span>
                            <span id="profile-v2-email" class="value">automation1900@gmail.com</span>
                        </div>
                         <div class="profile-v2-detail-item">
                            <span class="label">Phone</span>
                            <span id="profile-v2-phone" class="value">Not Set</span>
                        </div>
                    </div>
                     <div class="profile-v2-stats-card">
                        <div class="profile-v2-stat">
                            <span class="label">Support PIN</span>
                             <span id="profile-v2-pin" class="value">1550</span>
                        </div>
                        <div class="profile-v2-stat">
                            <span class="label">Total Matches</span>
                             <span id="profile-v2-matches" class="value">0</span>
                        </div>
                    </div>
                    <button id="profile-v2-logout-btn" class="btn ripple-effect">Logout</button>
                </div>
            </div>

            <div id="tournament-section" class="section">
                 <h2 class="page-title">FFARENA TOURNAMENTS</h2>
                 <div id="tournament-success" class="message success-message"></div>
                 <div id="tournament-category-selection">
                     <p style="text-align: center; padding: 20px 0;">Loading Tournament Categories...</p>
                 </div>
                 <button id="back-to-categories-btn" class="btn ripple-effect">Back to Categories</button>
                 <div id="classic-tournaments" class="tournament-category"></div>
                 <div id="clash-squad-tournaments" class="tournament-category"></div>
                 <div id="lone-wolf-tournaments" class="tournament-category"></div>
            </div>

            <div id="add-money-section" class="section">
                <h2 class="page-title">Add Money</h2>
                <div id="add-money-success" class="message success-message"></div>
                <div id="add-money-error" class="message error-message"></div>
                <div class="content-card">
                   <p class="info-text" style="background:var(--input-bg); border-radius:8px; padding:15px; text-align:center; margin-bottom: 20px;">Send money to <strong>01852093429 (Bkash)</strong> or <strong>01882912281 (Nagad)</strong>. Then submit details.</p>
                   <form onsubmit="return false;" id="add-money-form"> <div class="form-field"><input type="text" id="transaction-id" placeholder="Transaction ID" required></div> <div class="form-field"><input type="number" id="add-amount" placeholder="Amount (BDT)" required></div> <button id="add-money-btn" class="btn btn-primary ripple-effect">Submit Request</button> </form>
                </div>
             </div>

             <div id="withdraw-money-section" class="section">
                <h2 class="page-title">Withdraw Money</h2>
                <div id="withdraw-success" class="message success-message"></div>
                <div id="withdraw-error" class="message error-message"></div>
                 <div class="content-card">
                    <form onsubmit="return false;" id="withdraw-form"> <div class="form-field"><input type="text" id="bkash-number" placeholder="Bkash Number" required></div> <div class="form-field"><input type="number" id="withdraw-amount" placeholder="Amount (BDT) (min 70 BDT)" required></div> <button id="withdraw-btn" class="btn btn-primary ripple-effect">Request Withdraw</button> </form>
                 </div>
             </div>
             
             <div id="transfer-section" class="section">
                <h2 class="page-title">Transfer Balance</h2>
                <div id="transfer-success" class="message success-message"></div>
                <div id="transfer-error" class="message error-message"></div>
                 <div class="content-card">
                    <form onsubmit="return false;" id="transfer-form"> <div class="form-field"><input type="text" id="transfer-username" placeholder="Recipient's Username" required></div> <div class="form-field"><input type="number" id="transfer-amount" placeholder="Amount (BDT) (min 30 BDT)" required></div> <button id="transfer-btn" class="btn btn-special ripple-effect">Transfer</button> </form>
                 </div>
             </div>

             <div id="withdraw-list-section" class="section">
                 <h2 class="page-title">Transaction History</h2>
                 <div class="content-card">
                    <div id="transaction-history-list"></div>
                 </div>
             </div>
             
            <div id="my-match-section" class="section">
                 <h2 class="page-title">My Matches</h2>
                 <div id="my-match-list" class="content-card">
                     <p style="text-align: center;">You have not joined any matches yet.</p>
                 </div>
            </div>

            <div id="support-section" class="section">
                <h2 class="page-title">Support</h2>
                <div class="support-card">
                    <h3>Follow Us</h3>
                    <a href="https://t.me/ffarena2" target="_blank" class="follow-us-item ripple-effect">
                        <svg class="telegram" viewBox="0 0 24 24"><path d="M9.78 18.65l.28-4.23l7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3L3.64 12c-.88-.25-.89-1.39.2-1.61l15.35-5.8c.73-.27 1.36.17 1.15.94l-2.66 12.58c-.28 1.13-1.04 1.4-1.92.88L9.78 18.65z"/></svg>
                        <span>Join our Telegram HelpLine</span>
                    </a>
                    <a href="#" class="follow-us-item ripple-effect">
                        <svg class="youtube" viewBox="0 0 24 24"><path d="M21.58 7.19c-.23-.86-.9-1.52-1.76-1.75C18.25 5 12 5 12 5s-6.25 0-7.82.44c-.86.23-1.52.89-1.75 1.75C2 8.75 2 12 2 12s0 3.25.43 4.81c.23.86.9 1.52 1.75 1.75C5.75 19 12 19 12 19s6.25 0 7.82-.44c.86.23-1.52.89-1.75-1.75C22 15.25 22 12 22 12s0-3.25-.42-4.81zM9.5 15.5V8.5l6 3.5l-6 3.5z"/></svg>
                        <span>Watch tutorials on YouTube</span>
                    </a>
                    <a href="https://m.me/j/AbbZs9SZTbGHuEsX/" target="_blank" class="follow-us-item ripple-effect">
                        <svg class="facebook" viewBox="0 0 24 24"><path d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 4.84 3.44 8.87 8 9.8V15H8v-3h2V9.5C10 7.57 11.57 6 13.5 6H16v3h-1.5c-1 0-1.5.5-1.5 1.5V12h3l-.5 3h-2.5v6.8c4.56-.93 8-4.96 8-9.8z"/></svg>
                        <span>Message us on Facebook</span>
                    </a>
                     <a href="https://chat.whatsapp.com/Dzj6WpylyM60TpRqgSvk2C?mode=ac_t" target="_blank" class="follow-us-item ripple-effect">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M17.7 7.7c0 4.1-3.4 7.4-7.7 7.4-.7 0-1.3-.1-2-.2l-1.7 1.7L7 17.6c-.2-.2-.4-.4-.5-.7l.8-2.3c-1.4-1.4-2.2-3.3-2.2-5.4 0-4.1 3.4-7.4 7.7-7.4s7.7 3.3 7.7 7.4zM14.4 10.7l-1.7 1.7c-.1.1-.1.1-.2.2-.4-.1-.8-.2-1.2-.2-1.6 0-2.9 1.3-2.9 2.9s1.3 2.9 2.9 2.9 2.9-1.3 2.9-2.9c0-.4-.1-.8-.2-1.2l1.7-1.7c.4.4.6.9.6 1.5 0 1.6-1.3 2.9-2.9 2.9s-2.9-1.3-2.9-2.9 1.3-2.9 2.9-2.9c.6 0 1.1.2 1.5.6z"/></svg>
                        <span>Join our WhatsApp Group</span>
                    </a>
                </div>
                 <div class="support-card">
                    <h3>Contact Us</h3>
                    <div class="contact-us-item">
                        <p>Email<strong>srpshourovdev@gmail.com</strong></p>
                    </div>
                     <div class="contact-us-item">
                        <p>Phone<strong>01852093429</strong></p>
                    </div>
                 </div>
            </div>

         </div>
    </div>

    <div id="side-menu-overlay"></div>
    <div id="side-menu">
        <div class="side-menu-header">
            <button class="close-menu-btn">&times;</button>
            <button class="settings-btn ripple-effect">
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.09-.75-1.7-.98L14 2.1c-.09-.2-.25-.33-.45-.33H10.45c-.2 0-.36.13-.45.33L9.1 4.07c-.6.23-1.18.58-1.7.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.12.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12-.64l2 3.46c.12.22.39.3.61.22l2.49 1c.52.4 1.09.75 1.7.98L10 21.9c.09.2.25.33.45.33h3.1c.2 0 .36.13-.45.33l.9-1.93c.6-.23 1.18-.58 1.7-.98l2.49 1c.22.09.49 0 .61.22l2-3.46c.12-.22-.07-.49-.12-.64l-2.11-1.65zm-7.43-2.52c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
            </button>
            <div class="user-icon">
                <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            </div>
            <h3 id="menu-username">Srp Shourov</h3>
            <p id="menu-user-email">srpshourov9@gmail.com</p>
        </div>
        <nav class="side-menu-nav">
             <a href="#" id="nav-home-btn" class="active"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/><path d="M0 0h24v24H0z" fill="none"/></svg>Home</a>
             <a href="#" id="nav-profile-btn"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>My Account</a>
             <a href="#" id="nav-my-match-btn"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2zM8 11H6V9h2v2zm0-3H6V6h2v2zm6 5h-4v-2h4v2zm0-3h-4V9h4v2zm0-3h-4V6h4v2zm4 5h-2v-2h2v2zm0-3h-2V9h2v2z"/></svg>My Match</a>
             <a href="#" id="nav-add-money-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/><path d="M0 0h24v24H0z" fill="none"/></svg>Add Money</a>
             <a href="#" id="nav-withdraw-money-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 13H5v-2h14v2z"/><path d="M0 0h24v24H0z" fill="none"/></svg>Withdraw Money</a>
             <a href="#" id="nav-withdraw-list-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14 17H4v2h10v-2zm6-8H4v2h16V9zM4 15h16v-2H4v2zM4 5v2h16V5H4z"/><path d="M0 0h24v24H0z" fill="none"/></svg>Transaction History</a>
             <a href="#" id="nav-transfer-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M15 14h-2v2h2v-2zm-4 0H9v2h2v-2zm10-4V7h-3V4h-2v3h-3v3h-2V7H8V4H6v3H3v3h2v2H3v3h3v3h2v-3h3v-3h2v3h3v-3h2v-2h3v-3h-2v-2h-2zm-4 4H7v-2h10v2z"/><path d="M0 0h24v24H0z" fill="none"/></svg>Transfer</a>
             <a href="#" id="nav-support-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/><path d="M0 0h24v24H0z" fill="none"/></svg>Support</a>
             <a href="#" id="menu-logout-btn"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>Logout</a>
        </nav>
    </div>
</div>

<div class="modal-overlay" id="reset-password-modal-overlay">
    <div class="modal">
        <div class="modal-header">Reset Password</div>
        <div class="modal-body">
            <p style="text-align: center; margin-bottom: 20px; color: var(--secondary-text);">Enter your registered email to receive a password reset link.</p>
            <form onsubmit="return false;">
                <div class="form-field">
                    <input type="email" id="reset-email" placeholder="Enter your email" required>
                </div>
            </form>
            <div id="reset-password-message" class="message" style="margin-top: 15px;"></div>
        </div>
        <div class="modal-actions">
            <button id="cancel-reset-btn" class="btn cancel ripple-effect">Cancel</button>
            <button id="confirm-reset-btn" class="btn btn-primary ripple-effect">Send Link</button>
        </div>
    </div>
</div>
    
<div class="modal-overlay" id="gamer-tag-modal-overlay"> 
    <div class="modal"> 
        <div class="modal-header">Enter Your Team Details</div> 
        <div class="modal-body" id="gamer-tag-inputs"></div> 
        <div id="gamer-tag-error" class="message error-message" style="margin-top: 15px;"></div> 
        <div class="modal-actions"> 
            <button id="cancel-join-btn" class="btn cancel ripple-effect">Cancel</button> 
            <button id="confirm-join-btn" class="btn btn-primary ripple-effect">Confirm Join</button> 
        </div> 
    </div> 
</div>

<div class="modal-overlay" id="details-modal-overlay">
    <div class="modal">
        <div class="modal-header" id="details-modal-title">Tournament Details</div>
        <div class="modal-body" id="details-modal-content"></div>
        <div class="modal-actions">
            <button id="details-modal-close-btn" class="btn btn-primary ripple-effect">Close</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="player-list-modal-overlay">
    <div class="modal">
        <div class="modal-header">Joined Teams</div>
        <div class="modal-body" id="player-list-modal-content"></div>
        <div class="modal-actions">
            <button id="player-list-modal-close-btn" class="btn btn-primary ripple-effect">Close</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="join-team-modal-overlay">
    <div class="modal">
        <div class="modal-header">Join Existing Team</div>
        <div class="modal-body" id="join-team-inputs">
        </div>
        <div id="join-team-error" class="message error-message"></div>
        <div class="modal-actions">
            <button id="cancel-join-team-btn" class="btn cancel ripple-effect">Cancel</button>
            <button id="confirm-join-team-btn" class="btn btn-success ripple-effect">Confirm & Pay</button>
        </div>
    </div>
</div>


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, inMemoryPersistence, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getDatabase, ref, set, onValue, runTransaction, get, push, update } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    // --- Firebase and Auth Initialization ---
    const firebaseConfig = {
      apiKey: "AIzaSyCGQIUYCFzdNZfx-KIjVZ435oeKDQdSeJk",
      authDomain: "ffarena-3305a.firebaseapp.com",
      databaseURL: "https://ffarena-3305a-default-rtdb.firebaseio.com",
      projectId: "ffarena-3305a",
      storageBucket: "ffarena-3305a.firebasestorage.app",
      messagingSenderId: "285029626101",
      appId: "1:285029626101:web:c4d8702618162f254a95bc",
      measurementId: "G-C7QVPB496S"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();
    
    setPersistence(auth, inMemoryPersistence);


    // --- Global Variables & DOM Elements ---
    const sections = document.querySelectorAll('.section');
    const menuNavLinks = document.querySelectorAll('.side-menu-nav a');
    let currentUserId = null;
    let countdownIntervals = {};
    let tournamentCategories = {};
    let userListener = null; // To hold the reference to the user data listener

    // --- RIPPLE EFFECT FUNCTION ---
    function createRipple(event) {
        const button = event.currentTarget;
        const circle = document.createElement("span");
        const diameter = Math.max(button.clientWidth, button.clientHeight);
        const radius = diameter / 2;
        const rect = button.getBoundingClientRect();
        circle.style.width = circle.style.height = `${diameter}px`;
        circle.style.left = `${event.clientX - rect.left - radius}px`;
        circle.style.top = `${event.clientY - rect.top - radius}px`;
        circle.classList.add("ripple");
        const ripple = button.getElementsByClassName("ripple")[0];
        if (ripple) { ripple.remove(); }
        button.appendChild(circle);
    }
    
    function applyRippleEffect() {
        document.querySelectorAll(".ripple-effect").forEach(btn => btn.addEventListener("click", createRipple));
    }


    // --- Core UI & Message Functions ---
    function getFriendlyErrorMessage(error) {
        const defaultMessage = "An unexpected error occurred. Please try again.";
        if (!error) return defaultMessage;
        if (error.code) {
            switch (error.code) {
                case 'auth/invalid-email': return 'FFARENA Error: Please enter a valid email address.';
                case 'auth/user-not-found': return 'FFARENA Error: No user found with this email.';
                case 'auth/wrong-password': return 'FFARENA Error: Invalid credentials. Please check your email and password.';
                case 'auth/email-already-in-use': return 'FFARENA Error: This email address is already registered.';
                case 'auth/weak-password': return 'FFARENA Error: Password is too weak. It should be at least 6 characters.';
                default: return `FFARENA Error: ${error.code.replace('auth/', '').replace(/-/g, ' ')}`;
            }
        }
        if (error.message) { return error.message; }
        return defaultMessage;
    }
    
    function showMessage(id, msg, isError = false) {
        const el = document.getElementById(id);
        if (el) {
            el.textContent = msg;
            el.className = isError ? 'message error-message' : 'message success-message';
            el.style.display = 'block';
        }
    }
    function hideMessage(id) { const el = document.getElementById(id); if (el) { el.style.display = 'none'; } }
    function showFlashMessage(id, msg, isError = false) {
        showMessage(id, msg, isError);
        setTimeout(() => hideMessage(id), 4000);
    }
    
    function toggleForm(isLogin) {
        document.getElementById('login-form').classList.toggle('active', isLogin);
        document.getElementById('register-form').classList.toggle('active', !isLogin);
        document.getElementById('show-login-btn').classList.toggle('active', isLogin);
        document.getElementById('show-register-btn').classList.toggle('active', !isLogin);
        document.getElementById('auth-title').textContent = isLogin ? 'FFARENA LOGIN' : 'FFARENA REGISTER';
        hideMessage('auth-error');
    }

    function switchSection(targetId) {
        sections.forEach(s => s.classList.remove('active'));
        document.getElementById(targetId)?.classList.add('active');
        menuNavLinks.forEach(b => b.classList.toggle('active', b.id.includes(targetId.split('-')[0])));
        
        if(targetId === 'tournament-section') {
            showTournamentCategory('selection'); 
        }

        if (!currentUserId) return;
        
        if (targetId === 'tournament-section') {
            loadTournamentCategories().then(() => loadTournaments(currentUserId));
        } else if (targetId === 'my-match-section') {
            loadMyMatches(currentUserId);
        } else if (targetId === 'profile-section') {
             loadUserProfile(currentUserId);
        } else if (['add-money-section', 'withdraw-money-section', 'transfer-section', 'withdraw-list-section'].includes(targetId)) {
            loadTransactionHistory(currentUserId);
        }
        closeSideMenu();
    }

    function showTournamentCategory(targetId) {
        const selectionScreen = document.getElementById('tournament-category-selection');
        const backButton = document.getElementById('back-to-categories-btn');
        const lists = document.querySelectorAll('.tournament-category');

        if(targetId === 'selection') {
            selectionScreen.style.display = 'block';
            backButton.style.display = 'none';
            lists.forEach(list => list.classList.remove('active'));
        } else {
            selectionScreen.style.display = 'none';
            backButton.style.display = 'block';
            lists.forEach(list => list.classList.toggle('active', list.id === targetId));
        }
    }

    function openSideMenu() { document.getElementById('side-menu').classList.add('active'); document.getElementById('side-menu-overlay').classList.add('active'); }
    function closeSideMenu() { document.getElementById('side-menu').classList.remove('active'); document.getElementById('side-menu-overlay').classList.remove('active'); }

    // --- DATA LOADING FUNCTIONS ---
    async function loadTournamentCategories() {
        const categoryContainer = document.getElementById('tournament-category-selection');
        try {
            const categoriesSnap = await get(ref(db, 'tournament_categories'));
            if (categoriesSnap.exists()) {
                tournamentCategories = categoriesSnap.val();
                categoryContainer.innerHTML = '';
                Object.entries(tournamentCategories).forEach(([key, category]) => {
                    const normalizedKey = key.replace(/_/g, '-');
                    const card = document.createElement('div');
                    card.className = 'category-selection-card ripple-effect';
                    card.dataset.target = `${normalizedKey}-tournaments`; 
                    card.style.backgroundImage = `url('${category.backgroundUrl || ''}')`;
                    card.innerHTML = `
                        <img src="${category.iconUrl || 'https://i.ibb.co/6yT4R45/default-avatar.png'}" alt="${category.name}" class="category-icon">
                        <div class="content">
                          <h3>${category.name || 'Unnamed Category'}</h3>
                          <p id="${normalizedKey}-match-count">0 Matches Found</p>
                        </div>
                    `;
                    categoryContainer.appendChild(card);
                });
                applyRippleEffect();
            } else {
                categoryContainer.innerHTML = '<p style="text-align: center;">No tournament categories found.</p>';
            }
        } catch (error) {
            console.error("Failed to load tournament categories:", error);
            categoryContainer.innerHTML = '<p style="text-align: center; color: var(--error-color);">Error loading categories. Check console and Firebase rules.</p>';
        }
    }

    // New function to load essential user data for header and menu instantly on login
    function loadHeaderAndMenuData(uid) {
        const userRef = ref(db, `users/${uid}`);
        // Detach any previous listener before attaching a new one
        if (userListener) userListener();
        
        userListener = onValue(userRef, (snapshot) => {
            if (!snapshot.exists()) return;
            const data = snapshot.val();
            const balance = (data.balance || 0).toFixed(2);
            
            // Update header balance
            document.getElementById('header-balance').textContent = balance;
            
            // Update side-menu details
            document.getElementById('menu-username').textContent = data.username || 'N/A';
            document.getElementById('menu-user-email').textContent = data.email || 'N/A';
        });
    }

    function loadUserProfile(uid) {
        const userRef = ref(db, `users/${uid}`);
        // This function is for the dedicated profile page, so a 'get' is efficient.
        get(userRef).then(snapshot => {
            if (!snapshot.exists()) return;
            const data = snapshot.val();
            const balance = (data.balance || 0).toFixed(2);
            
            document.getElementById('profile-v2-username').textContent = data.username || 'N/A';
            document.getElementById('profile-v2-email').textContent = data.email || 'N/A';
            document.getElementById('profile-v2-phone').textContent = data.phone || 'Not Set';
            document.getElementById('profile-v2-pin').textContent = data.pin || '****';
            document.getElementById('profile-v2-balance').textContent = `${balance} BDT`;
            
            const localPic = localStorage.getItem(`profilePic_${uid}`);
            document.getElementById('profile-v2-pic').src = localPic || data.profilePicUrl || "https://i.ibb.co/6yT4R45/default-avatar.png";
        });
        
        get(ref(db, 'tournaments')).then(tournamentsSnap => {
            let matchCount = 0;
            if(tournamentsSnap.exists()){
                tournamentsSnap.forEach(tSnap => {
                    const tournament = tSnap.val();
                    const players = tournament.players || {};
                    if (Object.values(players).some(team => team.members && team.members.some(member => member && member.userId === uid))) {
                        matchCount++;
                    }
                });
            }
            document.getElementById('profile-v2-matches').textContent = matchCount;
        });
    }
    
    function loadMyMatches(userId) {
        const listEl = document.getElementById('my-match-list');
        listEl.innerHTML = '<p>Loading your matches...</p>';
        onValue(ref(db, 'tournaments'), (snapshot) => {
            Object.values(countdownIntervals).forEach(clearInterval);
            countdownIntervals = {};
            const myMatches = [];
            if(snapshot.exists()){
                snapshot.forEach(childSnapshot => {
                    const t = childSnapshot.val();
                    const players = t.players || {};
                    if (Object.values(players).some(team => team.members && team.members.some(member => member && member.userId === userId))) {
                        myMatches.push({ key: childSnapshot.key, ...t });
                    }
                });
            }
            if(myMatches.length === 0){
                listEl.innerHTML = '<p style="text-align:center;">You have not joined any matches yet.</p>';
                return;
            }
            listEl.innerHTML = '';
            myMatches.sort((a, b) => new Date(b.startTime) - new Date(a.startTime)).forEach(t => {
                const card = createTournamentCard(t.key, t, userId);
                listEl.appendChild(card);
            });
            applyRippleEffect();
        });
    }

    function startCountdown(elementId, startTime) {
        if (countdownIntervals[elementId]) clearInterval(countdownIntervals[elementId]);
        const countdownElement = document.getElementById(elementId);
        if (!countdownElement) return;
        const matchTime = new Date(startTime).getTime();
        const update = () => {
            const distance = matchTime - new Date().getTime();
            if (distance < 0) {
                clearInterval(countdownIntervals[elementId]);
                if(countdownElement.parentElement) countdownElement.parentElement.innerHTML = `<p class="match-started-text">Match Started</p>`;
                delete countdownIntervals[elementId];
                return;
            }
            const d = Math.floor(distance/(1000*60*60*24)), h = Math.floor((distance%(1000*60*60*24))/(1000*60*60)), m = Math.floor((distance%(1000*60*60))/(1000*60)), s = Math.floor((distance%(1000*60))/1000);
            countdownElement.innerHTML = `${d}d : ${h}h : ${m}m : ${s}s`;
        };
        update();
        countdownIntervals[elementId] = setInterval(update, 1000);
    }
    
    function createTournamentCard(key, t, currentUserId) {
        const players = t.players || {};
        const joinedPlayerCount = Object.values(players).reduce((acc, team) => acc + (team.members ? team.members.length : 0), 0);
        const maxPlayers = t.maxPlayers || 1;
        const isFull = joinedPlayerCount >= maxPlayers;
        const hasStarted = t.startTime ? new Date(t.startTime).getTime() < new Date().getTime() : false;
        let hasAccess = false;
        if (players && currentUserId) {
            hasAccess = Object.values(players).some(team =>
                team.members && team.members.some(member => member && member.userId === currentUserId)
            );
        }
        const progressPercentage = (joinedPlayerCount / maxPlayers) * 100;
        const prizeDetailsHtml = t.prizeDetails ? t.prizeDetails.replace(/\\n/g, '\n') : 'No prize details available.';
        let actionButtonHtml = hasAccess ? `<button class="btn btn-info room-id-btn ripple-effect" data-id="${key}">Room ID</button>` :
                               (isFull || hasStarted) ? `<button class="btn" style="background-color:#5a6268; flex-grow:1" disabled>Full</button>` :
                               `<button class="btn btn-success join-btn ripple-effect" data-id="${key}" data-fee="${t.entryFee}" data-players-per-team="${t.playersPerTeam || 1}">Join</button>`;
        let countdownHtml = t.startTime ? (hasStarted ? '<p class="match-started-text">Match Started</p>' : `<div class="countdown" id="countdown-${key}"></div>`) : '<p class="countdown">Time: TBD</p>';
        const card = document.createElement('div');
        card.className = 'new-tournament-card';
        card.innerHTML = `
            <div class="card-header ripple-effect" data-id="${key}">
                <img src="${t.imageUrl || 'https://i.ibb.co/6yT4R45/default-avatar.png'}" alt="mode">
                <div class="card-header-title">
                    <h3>${t.name}</h3>
                    <p>${(t.playersPerTeam || 1) > 1 ? `${t.playersPerTeam} vs ${t.playersPerTeam}` : 'Solo'} | ${t.startTime ? new Date(t.startTime).toLocaleTimeString('en-BD', { hour: 'numeric', minute: '2-digit'}) : 'TBD'}</p>
                </div>
            </div>
            <div class="card-body">
                <div class="details-grid">
                    <div class="detail-item"><p>TOTAL PRIZE</p><span> ${t.totalPrize || 0}</span></div>
                    <div class="detail-item"><p>PER KILL</p><span> ${t.perKillBonus || 0}</span></div>
                    <div class="detail-item"><p>ENTRY FEE</p><span> ${t.entryFee || 0}</span></div>
                </div>
                <div class="sub-details-grid">
                     <div class="detail-item"><p>TYPE</p><span>${t.type || ((t.playersPerTeam||1) > 1 ? 'Squad' : 'Solo')}</span></div>
                     <div class="detail-item"><p>VERSION</p><span>${t.version || 'Mobile'}</span></div>
                     <div class="detail-item"><p>MAP</p><span>${t.map || 'Bermuda'}</span></div>
                </div>
                <div class="countdown-container">${countdownHtml}</div>
                <div class="player-progress-section view-players-btn" data-id="${key}" data-max-players-per-team="${t.playersPerTeam || 1}">
                    <span class="player-count">${joinedPlayerCount} Joined</span>
                    <div class="progress-bar-container"><div class="progress-bar-fill" style="width: ${progressPercentage}%;"></div></div>
                    <span class="player-count">${Math.max(0, maxPlayers - joinedPlayerCount)} Left</span>
                </div>
            </div>
            <div class="prize-list-details" id="prize-list-${key}">${prizeDetailsHtml}</div>
            <div class="card-footer">
                <button class="btn btn-info prize-list-btn ripple-effect" data-target="prize-list-${key}">Prize List</button>
                ${actionButtonHtml}
            </div>`;
        if (t.startTime && !hasStarted) {
            setTimeout(() => startCountdown(`countdown-${key}`, t.startTime), 0);
        }
        return card;
    }

    function loadTournaments(currentUserId) {
        const classicListEl = document.getElementById('classic-tournaments');
        const clashSquadListEl = document.getElementById('clash-squad-tournaments');
        const loneWolfListEl = document.getElementById('lone-wolf-tournaments');
        
        onValue(ref(db, 'tournaments'), (snapshot) => {
            Object.values(countdownIntervals).forEach(clearInterval);
            countdownIntervals = {};
            classicListEl.innerHTML = ''; clashSquadListEl.innerHTML = ''; loneWolfListEl.innerHTML = '';
            let matchCounts = { classic: 0, 'clash-squad': 0, 'lone-wolf': 0 };
            if (!snapshot.exists()) { 
                classicListEl.innerHTML = '<p style="text-align:center;">No active tournaments.</p>';
                return; 
            }
            let tournaments = [];
            snapshot.forEach(childSnapshot => {
                tournaments.push({ key: childSnapshot.key, ...childSnapshot.val() });
            });
            tournaments.sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
            tournaments.forEach(t => {
                const card = createTournamentCard(t.key, t, currentUserId);
                const category = t.category || 'classic';
                const listEl = document.getElementById(`${category}-tournaments`);
                if(listEl) {
                    listEl.appendChild(card);
                    if(matchCounts[category] !== undefined) matchCounts[category]++;
                } else {
                     classicListEl.appendChild(card);
                     matchCounts.classic++;
                }
            });
            Object.keys(matchCounts).forEach(categoryKey => {
                const countEl = document.getElementById(`${categoryKey}-match-count`);
                if (countEl) countEl.textContent = `${matchCounts[categoryKey]} Matches Found`;
            });
            if(classicListEl.innerHTML === '') classicListEl.innerHTML = '<p style="text-align:center;">No Classic matches available.</p>';
            if(clashSquadListEl.innerHTML === '') clashSquadListEl.innerHTML = '<p style="text-align:center;">No Clash Squad matches available.</p>';
            if(loneWolfListEl.innerHTML === '') loneWolfListEl.innerHTML = '<p style="text-align:center;">No Lone Wolf matches available.</p>';
            applyRippleEffect();
        });
    }

    async function loadTransactionHistory(userId) {
        const listEl = document.getElementById('transaction-history-list');
        if (!listEl) return;
        listEl.innerHTML = '<p>Loading history...</p>';
        try {
            const [addMoneySnap, withdrawSnap, transfersSnap] = await Promise.all([
                get(ref(db, `addMoneyRequests`)),
                get(ref(db, `withdrawRequests`)),
                get(ref(db, `transfers`))
            ]);
            let allTxs = [];
            if (addMoneySnap.exists()) { Object.entries(addMoneySnap.val()).forEach(([id, tx]) => { if (tx && tx.userId === userId) { allTxs.push({ id, ...tx, type: 'Add Money' }); } }); }
            if (withdrawSnap.exists()) { Object.entries(withdrawSnap.val()).forEach(([id, tx]) => { if (tx && tx.userId === userId) { allTxs.push({ id, ...tx, type: 'Withdraw' }); } }); }
            if (transfersSnap.exists()) { Object.entries(transfersSnap.val()).forEach(([id, tx]) => { if (tx) { if (tx.senderId === userId) { allTxs.push({ id, ...tx, type: 'Sent' }); } if (tx.recipientId === userId) { allTxs.push({ id, ...tx, type: 'Received' }); } } }); }
            allTxs.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            if (allTxs.length === 0) {
                listEl.innerHTML = '<p style="text-align:center;">No transaction history found.</p>';
                return;
            }
            listEl.innerHTML = '';
            allTxs.forEach(tx => {
                const date = new Date(tx.timestamp || Date.now()).toLocaleString('en-BD', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                let typeDisplay, amountDisplay, amountClass;
                if (tx.type === 'Sent') {
                    typeDisplay = `Transfer to ${tx.recipientUsername || 'Unknown'}`;
                    amountDisplay = `-${tx.amount || 0} BDT`;
                    amountClass = 'Debit';
                } else if (tx.type === 'Received') {
                    typeDisplay = `Transfer from ${tx.senderUsername || 'Unknown'}`;
                    amountDisplay = `+${tx.amount || 0} BDT`;
                    amountClass = 'Credit';
                } else {
                    typeDisplay = tx.type;
                    const status = tx.status || 'Pending';
                    if (status === 'Approved') {
                        amountDisplay = `${tx.type === 'Add Money' ? '+' : '-'}${tx.amount || 0} BDT`;
                        amountClass = tx.type === 'Add Money' ? 'Credit' : 'Debit';
                    } else {
                        amountDisplay = status;
                        amountClass = status;
                    }
                }
                const itemEl = document.createElement('div');
                itemEl.className = 'transaction-item';
                itemEl.innerHTML = `<div class="transaction-info"><p class="type">${typeDisplay}</p><p class="date">${date}</p></div><div class="transaction-amount ${amountClass}">${amountDisplay}</div>`;
                listEl.appendChild(itemEl);
            });
        } catch (error) {
            console.error("History Loading Error:", error);
            listEl.innerHTML = `<p style="color: var(--error-color); text-align:center;">Could not load history.</p>`;
        }
    }

    // --- MODAL & JOIN LOGIC ---
    function closeDetailsModal() { document.getElementById('details-modal-overlay').classList.remove('active'); }
    function closePlayerListModal() { document.getElementById('player-list-modal-overlay').classList.remove('active'); }
    function closeJoinTeamModal() { document.getElementById('join-team-modal-overlay').classList.remove('active'); }
    function openResetPasswordModal() { document.getElementById('reset-password-modal-overlay').classList.add('active'); hideMessage('reset-password-message'); }
    function closeResetPasswordModal() { document.getElementById('reset-password-modal-overlay').classList.remove('active'); }
    
    async function showTournamentDetailsModal(tournamentId) {
        const modalOverlay = document.getElementById('details-modal-overlay');
        const modalTitleEl = document.getElementById('details-modal-title');
        const modalContentEl = document.getElementById('details-modal-content');
        modalTitleEl.textContent = 'Loading...';
        modalContentEl.innerHTML = '<p>Fetching tournament information...</p>';
        modalOverlay.classList.add('active');
        try {
            const tournamentSnap = await get(ref(db, `tournaments/${tournamentId}`));
            if (!tournamentSnap.exists()) throw new Error("Tournament not found.");
            
            const t = tournamentSnap.val();
            modalTitleEl.textContent = t.name;
            let roomDetailsHtml = ``;
            const players = t.players || {};
            
            let hasAccess = false;
            if (currentUserId) {
                hasAccess = Object.values(players).some(team => 
                    team.members && team.members.some(member => member && member.userId === currentUserId)
                );
            }

            if(hasAccess){
                roomDetailsHtml = `
                <div class="details-modal-section">
                    <h4>Room Details</h4>
                    <p><strong>Room ID:</strong> ${t.roomID || 'Announced Soon'}</p>
                    <p><strong>Password:</strong> ${t.roomPass || 'Announced Soon'}</p>
                </div>`;
            }
            modalContentEl.innerHTML = `
                <div class="details-modal-section">
                    <h4>Key Information</h4>
                    <p><strong>Entry Fee:</strong> ${t.entryFee} BDT</p>
                    <p><strong>Start Time:</strong> ${t.startTime ? new Date(t.startTime).toLocaleString('en-US', { dateStyle: 'long', timeStyle: 'short' }) : 'TBD'}</p>
                </div>
                ${roomDetailsHtml}
                <div class="details-modal-section">
                    <h4>Details & Rules</h4>
                    <p style="white-space: pre-wrap; word-wrap: break-word;">${t.detailsAndRules || 'No specific rules provided.'}</p>
                </div>`;
        } catch (error) { modalContentEl.innerHTML = `<p style="color: var(--error-color);">Could not load details: ${error.message}</p>`; }
     }

    async function showPlayerListModal(tournamentId, maxPlayersPerTeam) {
        const modalOverlay = document.getElementById('player-list-modal-overlay');
        const modalContentEl = document.getElementById('player-list-modal-content');
        modalContentEl.innerHTML = '<p>Loading teams...</p>';
        modalOverlay.classList.add('active');
        try {
            const playersSnap = await get(ref(db, `tournaments/${tournamentId}/players`));
            if (!playersSnap.exists()) {
                modalContentEl.innerHTML = '<p>No teams have joined yet.</p>';
                return;
            }
            const allTeams = playersSnap.val();
            let isUserAlreadyInTeam = Object.values(allTeams).some(team => 
                team.members && team.members.some(member => member && member.userId === currentUserId)
            );
            modalContentEl.innerHTML = '';
            Object.entries(allTeams).forEach(([teamLeaderId, team]) => {
                if (!team || !Array.isArray(team.members)) return;
                const teamCard = document.createElement('div');
                teamCard.className = 'team-view-card';
                const gamertagsHtml = team.members.map(member => `<li>${member.gamerTag || 'Unknown Player'}</li>`).join('');
                const membersCount = team.members.length;
                const isTeamFull = membersCount >= maxPlayersPerTeam;
                const availableSlots = maxPlayersPerTeam - membersCount;
                let joinButtonHtml = (!isTeamFull && !isUserAlreadyInTeam) 
                    ? `<button class="btn btn-success join-existing-team-btn ripple-effect" data-tournament-id="${tournamentId}" data-team-leader-id="${teamLeaderId}" data-available-slots="${availableSlots}">Join Team</button>` 
                    : '';
                teamCard.innerHTML = `
                    <h4>${team.teamName || 'Unnamed Team'}</h4>
                    <p class="slot-count">Players: ${membersCount}/${maxPlayersPerTeam}</p>
                    <ul class="gamertag-list">${gamertagsHtml}</ul>
                    ${joinButtonHtml}`;
                modalContentEl.appendChild(teamCard);
            });
            applyRippleEffect();
        } catch (error) {
            modalContentEl.innerHTML = `<p style="color: var(--error-color);">Could not load player list. ${error.message}</p>`;
            console.error("Error in showPlayerListModal:", error);
        }
    }

    function showJoinTournamentModal(tournamentId, entryFee, playersPerTeam) {
        const modalOverlay = document.getElementById('gamer-tag-modal-overlay');
        const gamerTagInputsContainer = document.getElementById('gamer-tag-inputs');
        gamerTagInputsContainer.innerHTML = '';
        hideMessage('gamer-tag-error');
        let inputHtml = `<div class="form-field" style="margin-bottom: 20px;">
                            <label for="join-team-name">Team Name:</label>
                            <input type="text" id="join-team-name" placeholder="Enter your team name" required>
                         </div>`;
        for (let i = 0; i < playersPerTeam; i++) {
            const usernameInputHtml = (i === 0) ? '' : `
                <div class="form-field" style="margin-bottom: 0;">
                    <label for="username-input-${i}">Player's Username (Optional):</label>
                    <input type="text" id="username-input-${i}" class="username-input-field" placeholder="Share room access with user">
                </div>`;
            inputHtml += `<div class="player-input-group">
                            <div class="form-field" style="margin-bottom: 12px;">
                                <label for="gamer-tag-input-${i}">Gamer Tag (Player ${i + 1}):</label>
                                <input type="text" id="gamer-tag-input-${i}" class="gamer-tag-input-field" placeholder="${i === 0 ? "Enter Your Gamer Tag" : "Enter Gamer Tag or 'add'"}">
                            </div>
                            ${usernameInputHtml}
                          </div>`;
        }
        gamerTagInputsContainer.innerHTML = inputHtml;
        modalOverlay.classList.add('active');
        document.getElementById('confirm-join-btn').onclick = async () => {
            const teamName = document.getElementById('join-team-name').value.trim();
            if (!teamName) return showMessage('gamer-tag-error', 'Team Name is required.', true);
            const gamerTagInputs = [...document.querySelectorAll('.gamer-tag-input-field')];
            let newMembers = [];
            let collectedUsernames = [];
            for (let i = 0; i < gamerTagInputs.length; i++) {
                const tag = gamerTagInputs[i].value.trim();
                const usernameInput = document.getElementById(`username-input-${i}`);
                const username = usernameInput ? usernameInput.value.trim() : '';
                if (i === 0 && (!tag || tag.toLowerCase() === 'add')) {
                    return showMessage('gamer-tag-error', "Player 1's Gamer Tag is required and cannot be 'add'.", true);
                }
                if (tag && tag.toLowerCase() !== 'add') {
                    let memberUserId = (i === 0) ? currentUserId : null;
                    newMembers.push({ gamerTag: tag, userId: memberUserId });
                    if (username) {
                        collectedUsernames.push({ username: username.toLowerCase(), memberIndex: newMembers.length - 1 });
                    }
                }
            }
            if (newMembers.length === 0) return showMessage('gamer-tag-error', 'Please enter at least one valid Gamer Tag.', true);
            const totalFee = entryFee * newMembers.length;
            try {
                if (collectedUsernames.length > 0) {
                    const allUsersSnap = await get(ref(db, 'users'));
                    if (!allUsersSnap.exists()) throw new Error("Could not verify users.");
                    const usernameToUidMap = {};
                    Object.entries(allUsersSnap.val()).forEach(([uid, userData]) => {
                        if (userData?.username) usernameToUidMap[userData.username.toLowerCase()] = uid;
                    });
                    for (const item of collectedUsernames) {
                        const foundUid = usernameToUidMap[item.username];
                        if (foundUid) newMembers[item.memberIndex].userId = foundUid;
                        else throw new Error(`User "${item.username}" not found.`);
                    }
                }
                await runTransaction(ref(db, `users/${currentUserId}/balance`), (currentBalance) => {
                    if ((currentBalance || 0) < totalFee) throw new Error("Insufficient balance.");
                    return currentBalance - totalFee;
                });
                await set(ref(db, `tournaments/${tournamentId}/players/${currentUserId}`), { teamName: teamName, joinedAt: Date.now(), members: newMembers });
                showFlashMessage('tournament-success', 'Successfully created team and joined!');
                modalOverlay.classList.remove('active');
            } catch (error) { showMessage('gamer-tag-error', getFriendlyErrorMessage(error), true); }
        };
        document.getElementById('cancel-join-btn').onclick = () => modalOverlay.classList.remove('active');
    }

    function showJoinExistingTeamModal(tournamentId, teamLeaderId, availableSlots) {
        const modal = document.getElementById('join-team-modal-overlay');
        const inputsContainer = document.getElementById('join-team-inputs');
        inputsContainer.innerHTML = '';
        hideMessage('join-team-error');
        let inputHtml = '';
        for (let i = 0; i < availableSlots; i++) {
            inputHtml += `<div class="player-input-group">
                            <div class="form-field" style="margin-bottom: 12px;">
                                <label for="join-new-gamertag-${i}">New Teammate's Gamer Tag (${i + 1}):</label>
                                <input type="text" id="join-new-gamertag-${i}" class="join-new-gamertag-field" placeholder="Enter Gamer Tag or 'add'">
                            </div>
                            <div class="form-field" style="margin-bottom: 0;">
                                <label for="join-new-username-${i}">Player's Username (Optional):</label>
                                <input type="text" id="join-new-username-${i}" class="join-new-username-field" placeholder="Share room access with user">
                            </div>
                          </div>`;
        }
        inputsContainer.innerHTML = inputHtml;
        modal.classList.add('active');
        document.getElementById('confirm-join-team-btn').onclick = async () => {
            const gamertagInputs = [...document.querySelectorAll('.join-new-gamertag-field')];
            const usernameInputs = [...document.querySelectorAll('.join-new-username-field')];
            let newMembers = [], collectedUsernames = [];
            let isCurrentUserAdded = false;
            for (let i = 0; i < gamertagInputs.length; i++) {
                const tag = gamertagInputs[i].value.trim();
                const username = usernameInputs[i].value.trim();
                if (tag && tag.toLowerCase() !== 'add') {
                    let memberUserId = null;
                    if (!isCurrentUserAdded) { memberUserId = currentUserId; isCurrentUserAdded = true; }
                    newMembers.push({ gamerTag: tag, userId: memberUserId });
                    if (username) collectedUsernames.push({ username: username.toLowerCase(), memberIndex: newMembers.length - 1 });
                }
            }
            if (newMembers.length === 0) return showMessage('join-team-error', "Please enter at least one valid Gamer Tag.", true);
            try {
                const tournamentSnap = await get(ref(db, `tournaments/${tournamentId}`));
                if (!tournamentSnap.exists()) throw new Error("Tournament not found.");
                const entryFee = tournamentSnap.val().entryFee || 0;
                const totalFee = entryFee * newMembers.length;
                if (collectedUsernames.length > 0) {
                    const allUsersSnap = await get(ref(db, 'users'));
                    if (!allUsersSnap.exists()) throw new Error("Could not verify users.");
                    const usernameToUidMap = {};
                    Object.entries(allUsersSnap.val()).forEach(([uid, userData]) => {
                        if (userData?.username) usernameToUidMap[userData.username.toLowerCase()] = uid;
                    });
                    for (const item of collectedUsernames) {
                        const foundUid = usernameToUidMap[item.username];
                        if (foundUid) newMembers[item.memberIndex].userId = foundUid;
                        else throw new Error(`User "${item.username}" not found.`);
                    }
                }
                await runTransaction(ref(db, `users/${currentUserId}/balance`), (currentBalance) => {
                    if ((currentBalance || 0) < totalFee) throw new Error(`Insufficient balance. Required: ${totalFee} BDT`);
                    return currentBalance - totalFee;
                });
                const teamRef = ref(db, `tournaments/${tournamentId}/players/${teamLeaderId}`);
                const teamSnap = await get(teamRef);
                if (!teamSnap.exists()) throw new Error("Team could not be found.");
                const teamData = teamSnap.val();
                const updatedMembers = [...(teamData.members || []), ...newMembers];
                await update(teamRef, { members: updatedMembers });
                showFlashMessage('tournament-success', 'Successfully joined the team!');
                modal.classList.remove('active');
                closePlayerListModal();
                showPlayerListModal(tournamentId, tournamentSnap.val().playersPerTeam || 1);
            } catch (error) { showMessage('join-team-error', getFriendlyErrorMessage(error), true); }
        };
        document.getElementById('cancel-join-team-btn').onclick = closeJoinTeamModal;
    }

    async function handleAddMoney() {
        hideMessage('add-money-error');
        const transactionId = document.getElementById('transaction-id').value.trim();
        const amount = parseFloat(document.getElementById('add-amount').value);
        if (!transactionId || !amount || amount <= 0) { return showFlashMessage('add-money-error', 'Please provide a valid Transaction ID and Amount.', true); }
        try {
            await set(push(ref(db, 'addMoneyRequests')), { userId: currentUserId, transactionId: transactionId, amount: amount, status: 'Pending', timestamp: Date.now() });
            showFlashMessage('add-money-success', 'Your add money request has been submitted.');
            document.getElementById('add-money-form').reset();
        } catch (error) { showFlashMessage('add-money-error', getFriendlyErrorMessage(error), true); }
    }
    async function handleWithdraw() {
        hideMessage('withdraw-error');
        const bkashNumber = document.getElementById('bkash-number').value.trim();
        const amount = parseFloat(document.getElementById('withdraw-amount').value);
        if (!bkashNumber || bkashNumber.length < 11) { return showFlashMessage('withdraw-error', 'Please enter a valid Bkash number.', true); }
        if (!amount || amount < 70) { return showFlashMessage('withdraw-error', 'Minimum withdrawal amount is 70 BDT.', true); }
        try {
            await runTransaction(ref(db, `users/${currentUserId}/balance`), (bal) => { if ((bal || 0) < amount) throw new Error("Insufficient balance."); return bal - amount; });
            await set(push(ref(db, 'withdrawRequests')), { userId: currentUserId, bkashNumber: bkashNumber, amount: amount, status: 'Pending', timestamp: Date.now() });
            showFlashMessage('withdraw-success', 'Withdrawal request submitted successfully.');
            document.getElementById('withdraw-form').reset();
        } catch (error) {
            showFlashMessage('withdraw-error', getFriendlyErrorMessage(error), true);
            if (!error.message.includes("Insufficient balance")) { runTransaction(ref(db, `users/${currentUserId}/balance`), (bal) => (bal || 0) + amount); }
        }
    }
    
    async function handleTransfer() {
        hideMessage('transfer-error');
        const recipientUsername = document.getElementById('transfer-username').value.trim();
        const amount = parseFloat(document.getElementById('transfer-amount').value);
        if (!recipientUsername || !amount || amount < 30) { 
            return showFlashMessage('transfer-error', 'Enter a valid username and amount (min 30 BDT).', true); 
        }

        try {
            const allUsersSnap = await get(ref(db, 'users'));
            if (!allUsersSnap.exists()) {
                throw new Error('Cannot find users.');
            }

            const allUsers = allUsersSnap.val();
            const lowerCaseRecipientUsername = recipientUsername.toLowerCase();
            let recipientId = null;

            // --- FIX START: More robust user search logic ---
            for (const uid in allUsers) {
                const userData = allUsers[uid];
                if (userData && userData.username && userData.username.toLowerCase() === lowerCaseRecipientUsername) {
                    recipientId = uid;
                    break; // Exit loop once the user is found
                }
            }
            // --- FIX END ---

            if (!recipientId) {
                throw new Error('Recipient user not found.');
            }

            if (recipientId === currentUserId) {
                throw new Error('You cannot transfer money to yourself.');
            }
            
            const senderUsername = allUsers[currentUserId]?.username || 'Unknown';

            await runTransaction(ref(db, `users/${currentUserId}/balance`), (currentBalance) => {
                if ((currentBalance || 0) < amount) {
                    throw new Error('Insufficient balance.');
                }
                return currentBalance - amount;
            });

            await runTransaction(ref(db, `users/${recipientId}/balance`), (currentBalance) => (currentBalance || 0) + amount);
            
            await push(ref(db, 'transfers'), { 
                senderId: currentUserId, 
                senderUsername, 
                recipientId, 
                recipientUsername, 
                amount, 
                timestamp: Date.now() 
            });

            showFlashMessage('transfer-success', `Successfully transferred ${amount} BDT to ${recipientUsername}.`);
            document.getElementById('transfer-form').reset();
        } catch (error) { 
            showFlashMessage('transfer-error', getFriendlyErrorMessage(error), true); 
        }
    }


    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        applyRippleEffect();

        document.getElementById('show-login-btn').addEventListener('click', () => toggleForm(true));
        document.getElementById('show-register-btn').addEventListener('click', () => toggleForm(false));

        document.getElementById('login-btn').addEventListener('click', () => {
             const email = document.getElementById('login-email').value;
             const password = document.getElementById('login-password').value;
             if (!email || !password) return showMessage('auth-error', 'Please enter email and password.', true);
             hideMessage('auth-error');
             signInWithEmailAndPassword(auth, email, password)
                .catch(err => showMessage('auth-error', getFriendlyErrorMessage(err), true));
        });
        
        document.getElementById('forgot-password-link').addEventListener('click', (e) => {
            e.preventDefault();
            openResetPasswordModal();
        });
        
        document.getElementById('confirm-reset-btn').addEventListener('click', () => {
            const email = document.getElementById('reset-email').value;
            if(!email) return showMessage('reset-password-message', 'Please enter your email address.', true);

            sendPasswordResetEmail(auth, email)
                .then(() => {
                    showMessage('reset-password-message', 'Password reset link sent! Please check your email inbox.', false);
                })
                .catch(err => {
                    showMessage('reset-password-message', getFriendlyErrorMessage(err), true);
                });
        });

        document.getElementById('cancel-reset-btn').addEventListener('click', closeResetPasswordModal);


        document.getElementById('register-btn').addEventListener('click', () => {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const username = document.getElementById('register-username').value;
            const phone = document.getElementById('register-phone').value;
            const pin = document.getElementById('register-pin').value;
            if (!email || !password || !username || !phone || !pin) return showMessage('auth-error', 'Please fill all fields.', true);
            if (pin.length !== 4 || !/^\d{4}$/.test(pin)) return showMessage('auth-error', 'Support PIN must be 4 digits.', true);
            hideMessage('auth-error');
            createUserWithEmailAndPassword(auth, email, password)
                .then(cred => set(ref(db, 'users/' + cred.user.uid), { 
                    username, email, phone, pin, balance: 0, profilePicUrl: "https://i.ibb.co/6yT4R45/default-avatar.png"
                }))
                .then(() => {
                    showFlashMessage('auth-error', 'Registration successful! Please log in.', false);
                    toggleForm(true);
                    document.getElementById('register-form').parentElement.querySelector('form').reset();
                })
                .catch(err => showMessage('auth-error', getFriendlyErrorMessage(err), true));
        });

        document.getElementById('profile-menu-btn').addEventListener('click', openSideMenu);
        document.getElementById('side-menu-overlay').addEventListener('click', closeSideMenu);
        document.querySelector('.close-menu-btn').addEventListener('click', closeSideMenu);
        
        menuNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.id.replace('nav-', '').replace('-btn', '') + '-section';
                if(link.id === 'nav-home-btn') switchSection('tournament-section');
                else if (link.id !== 'menu-logout-btn') switchSection(targetId);
            });
        });

        document.getElementById('home-logo-link').addEventListener('click', (e) => { e.preventDefault(); switchSection('tournament-section'); });
        
        const logoutUser = () => { signOut(auth); };
        document.getElementById('menu-logout-btn').addEventListener('click', logoutUser);
        document.getElementById('profile-v2-logout-btn').addEventListener('click', logoutUser);

        document.getElementById('profile-pic-upload').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file || !currentUserId) return;
            const MAX_FILE_SIZE_MB = 2;
            if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
                showFlashMessage('profile-info-success', `FFARENA Error: Image too large. Max ${MAX_FILE_SIZE_MB}MB.`, true);
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageDataUrl = e.target.result;
                try {
                    localStorage.setItem(`profilePic_${currentUserId}`, imageDataUrl);
                    document.getElementById('profile-v2-pic').src = imageDataUrl;
                    showFlashMessage('profile-info-success', 'Profile picture updated!');
                } catch (error) {
                    showFlashMessage('profile-info-success', 'FFARENA Error: Failed to save picture. Storage might be full.', true);
                }
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('tournament-category-selection').addEventListener('click', (e) => {
            const card = e.target.closest('.category-selection-card');
            if (card) showTournamentCategory(card.dataset.target);
        });
        
        document.getElementById('back-to-categories-btn').addEventListener('click', () => showTournamentCategory('selection'));

        document.getElementById('tournament-section').addEventListener('click', async e => {
            const prizeListBtn = e.target.closest('.prize-list-btn');
            const joinBtn = e.target.closest('.join-btn');
            const cardHeader = e.target.closest('.card-header');
            const roomIdBtn = e.target.closest('.room-id-btn');
            const viewPlayersBtn = e.target.closest('.view-players-btn');
            if (prizeListBtn) { const targetEl = document.getElementById(prizeListBtn.dataset.target); if(targetEl) targetEl.style.display = targetEl.style.display === 'block' ? 'none' : 'block'; } 
            else if (joinBtn) { const { id, fee, playersPerTeam } = joinBtn.dataset; showJoinTournamentModal(id, parseFloat(fee), parseInt(playersPerTeam)); } 
            else if (cardHeader || roomIdBtn) { const tournamentId = (cardHeader || roomIdBtn).dataset.id; showTournamentDetailsModal(tournamentId); } 
            else if (viewPlayersBtn) { const {id, maxPlayersPerTeam} = viewPlayersBtn.dataset; showPlayerListModal(id, parseInt(maxPlayersPerTeam)); }
        });
        
        document.getElementById('player-list-modal-overlay').addEventListener('click', e => {
            if (e.target.classList.contains('join-existing-team-btn')) { const { tournamentId, teamLeaderId, availableSlots } = e.target.dataset; showJoinExistingTeamModal(tournamentId, teamLeaderId, parseInt(availableSlots)); }
        });

        document.getElementById('details-modal-close-btn').addEventListener('click', closeDetailsModal);
        document.getElementById('player-list-modal-close-btn').addEventListener('click', closePlayerListModal);
        
        ['details-modal-overlay', 'player-list-modal-overlay', 'join-team-modal-overlay', 'gamer-tag-modal-overlay', 'reset-password-modal-overlay'].forEach(id => {
             document.getElementById(id).addEventListener('click', (e) => { if(e.target.id === id) e.target.classList.remove('active'); });
        });

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('auth-section').classList.remove('active');
                document.getElementById('app-section').classList.add('active');
                
                loadHeaderAndMenuData(user.uid); // Load essential data immediately
                
                document.getElementById('add-money-btn').onclick = handleAddMoney;
                document.getElementById('withdraw-btn').onclick = handleWithdraw;
                document.getElementById('transfer-btn').onclick = handleTransfer;
                switchSection('tournament-section');
            } else {
                currentUserId = null;
                if(userListener) userListener(); // Detach listener on logout
                Object.values(countdownIntervals).forEach(clearInterval);
                countdownIntervals = {};
                document.getElementById('auth-section').classList.add('active');
                document.getElementById('app-section').classList.remove('active');
                toggleForm(true); 
            }
        });
    });
</script>
</body>
</html>
