<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFARENA</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        :root {
            --bg-color: #1a1a2e;
            --card-bg: #16213e;
            --input-bg: #1a1a2e;
            --primary-text: #ffffff;
            --secondary-text: #e0e0e0;
            --accent-color: #e94560; /* Main action color (pink/red) */
            --success-color: #00c853; /* Green */
            --info-color: #0f3460;   /* Blue */
            --transfer-color: #5f27cd; /* Purple */
            --error-color: #ff3d00;
            --border-color: #0f3460;
            --prize-list-bg: #101c32;
            --premium-orange: #e67e22; /* New premium orange color */
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { height: 100%; }
        body {
            font-family: 'Poppins', sans-serif;
            color: var(--primary-text);
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            overflow: hidden;
            padding: 20px 0;
        }
        .container {
            width: 100%;
            max-width: 420px;
            height: 100%;
            background-color: var(--bg-color);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #auth-section, #app-section {
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }
        #auth-section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            justify-content: center;
        }
        #app-section.active, #auth-section.active { display: flex; }
        .scrollable-content {
            flex-grow: 1;
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
            scroll-behavior: smooth;
            padding: 0 15px;
        }
        .scrollable-content::-webkit-scrollbar { display: none; }
        .app-title { font-size: 2.2rem; font-weight: 700; margin-bottom: 30px; text-align: center; color: var(--primary-text); }
        .page-title { font-size: 2rem; font-weight: 700; margin: 20px 0; text-align: center; color: var(--accent-color); }
        .section { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .section.active { display: block; opacity: 1; }
        .content-card { background: var(--card-bg); border-radius: 15px; padding: 25px; margin-bottom: 20px; }
        .profile-pic-container { position: relative; width: 120px; height: 120px; margin: 0 auto 20px auto; border-radius: 50%; border: 3px solid var(--info-color); }
        #profile-pic-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; background-color: var(--input-bg); }
        #profile-pic-upload-label { position: absolute; bottom: 0; right: 0; background-color: var(--accent-color); color: var(--bg-color); width: 35px; height: 35px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; border: 2px solid var(--card-bg); }
        #profile-pic-upload { display: none; }
        .profile-info p { text-align: left; font-size: 1.1rem; margin-bottom: 15px; display: flex; align-items: center; }
        .profile-info strong { color: var(--primary-text); display: inline-block; width: 110px; flex-shrink: 0; }
        
        #upload-progress-container {
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            height: 6px;
            background-color: var(--input-bg);
            border-radius: 3px;
            display: none;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        #upload-progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--success-color);
            border-radius: 3px;
            transition: width 0.4s ease;
        }
        
        .tournament-nav {
            display: flex;
            justify-content: space-around;
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 20px;
        }
        .tournament-nav .nav-tab {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--secondary-text);
            padding: 12px 5px;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .tournament-nav .nav-tab.active {
            background-color: var(--accent-color);
            color: var(--primary-text);
            font-weight: 700;
        }
        .tournament-category { display: none; }
        .tournament-category.active { display: block; }

        .new-tournament-card {
            background-color: var(--card-bg);
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid var(--premium-orange);
        }
        .card-header {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: rgba(0,0,0,0.2);
            cursor: pointer;
        }
        .card-header img { width: 45px; height: 45px; border-radius: 8px; margin-right: 15px; }
        .card-header-title { flex-grow: 1; }
        .card-header-title h3 { font-size: 1.2rem; margin: 0; color: var(--primary-text); }
        .card-header-title p { font-size: 0.85rem; color: var(--secondary-text); margin: 0; }
        .card-body { padding: 15px; }
        .details-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            text-align: center;
            margin-bottom: 15px;
        }
        .detail-item p { margin: 0; font-size: 0.8rem; color: var(--secondary-text); }
        .detail-item span { font-size: 1.1rem; font-weight: 600; color: var(--primary-text); }
        .sub-details-grid {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 15px; text-align: center; margin-bottom: 20px; padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        .player-progress-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            cursor: pointer;
        }
        .progress-bar-container {
            flex-grow: 1; height: 10px; background-color: var(--input-bg);
            border-radius: 10px; overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%; background-color: var(--accent-color);
            border-radius: 10px;
        }
        .player-count { font-size: 0.9rem; color: var(--secondary-text); white-space: nowrap;}
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px 15px;
            gap: 10px;
        }
        .countdown { font-size: 0.9rem; font-weight: 500; text-align: center; color: var(--secondary-text); margin-bottom: 15px; }
        .match-started-text { color: var(--success-color); font-weight: 600; text-align: center; margin-bottom: 15px;}
        .prize-list-details {
            display: none;
            background-color: var(--prize-list-bg);
            padding: 15px;
            margin: 0 15px 15px;
            border-radius: 8px;
            white-space: pre-wrap;
        }
        .prize-list-details p { margin: 5px 0; color: var(--secondary-text); }
        .prize-list-details strong { color: var(--primary-text); }
        
        .form-switch { display: flex; justify-content: center; margin-bottom: 25px; background: var(--input-bg); border-radius: 10px; padding: 5px; }
        .form-switch button { flex: 1; background: transparent; border: none; color: var(--secondary-text); font-size: 1rem; font-weight: 500; cursor: pointer; padding: 10px; border-radius: 8px; transition: all 0.3s ease; }
        .form-switch button.active { background: var(--accent-color); color: var(--primary-text); font-weight: 600; box-shadow: 0 0 15px rgba(233, 69, 96, 0.5); }
        
        .form-container { display: none; } .form-container.active { display: block; }
        .form-field { margin-bottom: 18px; position: relative; }
        .form-field input { width: 100%; padding: 14px 15px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--primary-text); font-size: 0.95rem; }
        .modal .form-field label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--secondary-text); }
        
        .btn { padding: 12px 20px; color: var(--primary-text); border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease; text-align: center; }
        .btn:disabled { background-color: #5a6268; cursor: not-allowed; }
        .btn.btn-primary { background-color: var(--accent-color); width: 100%;}
        .btn.btn-danger { background-color: var(--error-color); width: 100%;}
        .btn.btn-success { background-color: var(--success-color); flex-grow: 1; }
        .btn.btn-info { background-color: var(--info-color); flex-grow: 1;}
        .btn.btn-special { background-color: var(--transfer-color); width: 100%;}
        
        .bottom-nav { flex-shrink: 0; border-top: 1px solid var(--border-color); background: var(--card-bg); border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; padding: 5px 0; }
        .bottom-nav-inner { display: flex; justify-content: space-around; }
        .bottom-nav button { background: none; border: none; color: var(--secondary-text); padding: 10px 20px; font-size: 0.8rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: color 0.3s ease; flex-grow: 1; }
        .bottom-nav button svg { width: 24px; height: 24px; fill: currentColor; }
        .bottom-nav button.active { color: var(--accent-color); }
        
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); 
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); 
            z-index: 1000; 
            display: none; 
            justify-content: center; 
            align-items: flex-start;
            padding-top: 5vh;
            overflow-y: auto;
        }
        .modal-overlay.active { display: flex; }
        .modal { 
            background: var(--bg-color); 
            border: 1px solid var(--border-color); 
            border-radius: 15px; 
            padding: 25px; 
            width: 90%; 
            max-width: 380px;
            margin-bottom: 5vh;
        }
        .modal .modal-body {
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-header { text-align: center; color: var(--accent-color); font-size: 1.5rem; font-weight: 600; margin-bottom: 20px; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-actions .cancel { background-color: #6c757d; }
        
        .details-modal-section { margin-bottom: 20px; }
        .details-modal-section h4 { color: var(--accent-color); margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .details-modal-section p { margin-bottom: 8px; color: var(--secondary-text); }
        .details-modal-section strong { color: var(--primary-text); }

        .message { padding: 12px 15px; margin-bottom: 15px; border-radius: 8px; text-align: center; display: none; font-weight: 500; }
        .message.success-message { background-color: var(--success-color); color: white; }
        .message.error-message { background-color: var(--error-color); color: white; }

        .transaction-item { display: flex; justify-content: space-between; align-items: center; background: var(--input-bg); padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .transaction-info p { margin: 0; }
        .transaction-info .type { font-weight: 600; font-size: 1rem; }
        .transaction-info .date { font-size: 0.8rem; color: var(--secondary-text); }
        .transaction-amount { font-weight: 600; padding: 5px 10px; border-radius: 20px; font-size: 0.9rem; }
        .transaction-amount.Credit { background-color: var(--success-color); color: #fff; }
        .transaction-amount.Debit { background-color: var(--error-color); color: #fff; }
        .transaction-amount.Pending { background-color: #ffab00; color: #000;}
        .transaction-amount.Rejected { background-color: var(--error-color); color: white; }

        #player-list-modal-content p {
            background-color: var(--input-bg);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            color: var(--primary-text);
            font-weight: 500;
            border-left: 3px solid var(--premium-orange);
        }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-section" class="active">
        <h1 class="app-title" id="auth-title">FFARENA LOGIN</h1>
        <div class="form-switch"> <button id="show-login-btn" class="active">Login</button> <button id="show-register-btn">Register</button> </div>
        <div id="login-form" class="form-container active"> <form onsubmit="return false;"> <div class="form-field"> <input type="email" id="login-email" placeholder="Email" required> </div> <div class="form-field"> <input type="password" id="login-password" placeholder="Password" required> </div> <button id="login-btn" class="btn btn-primary">Login</button> </form> </div>
        <div id="register-form" class="form-container"> <form onsubmit="return false;"> <div class="form-field"> <input type="text" id="register-username" placeholder="Username" required> </div> <div class="form-field"> <input type="email" id="register-email" placeholder="Email" required> </div> <div class="form-field"> <input type="password" id="register-password" placeholder="Password" required> </div> <div class="form-field"> <input type="password" id="register-confirm-password" placeholder="Confirm Password" required> </div> <button id="register-btn" class="btn btn-primary">Register</button> </form> </div>
        <div id="auth-error" class="message error-message"></div>
    </div>

    <div id="app-section">
         <div class="scrollable-content">
            <div id="profile-section" class="section">
                <h2 class="page-title">FFARENA PROFILE</h2>
                <div class="content-card">
                    <div class="profile-pic-container">
                        <img id="profile-pic-img" src="https://i.ibb.co/6yT4R45/default-avatar.png" alt="Profile Picture">
                        <label for="profile-pic-upload" id="profile-pic-upload-label"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 24 24" width="20" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg></label>
                        <input type="file" id="profile-pic-upload" accept="image/*">
                        <div id="upload-progress-container"><div id="upload-progress-bar"></div></div>
                    </div>
                    <div id="profile-info-success" class="message success-message"></div>
                    <div class="profile-info"> <p><strong>Username: </strong> <span id="profile-username"></span></p> <p><strong>Email: </strong> <span id="profile-email"></span></p> <p><strong>Balance: </strong> <span id="profile-balance"></span> BDT</p> </div>
                    <button id="logout-btn" class="btn btn-danger">Logout</button>
                </div>
            </div>
            <div id="tournament-section" class="section">
                 <h2 class="page-title">FFARENA TOURNAMENTS</h2>
                 <div id="tournament-success" class="message success-message"></div>
                 <div class="tournament-nav">
                    <button class="nav-tab active" data-target="classic-tournaments">CLASSIC</button>
                    <button class="nav-tab" data-target="clash-squad-tournaments">CLASH SQUAD</button>
                    <button class="nav-tab" data-target="lone-wolf-tournaments">LONE WOLF</button>
                 </div>
                 <div id="classic-tournaments" class="tournament-category active"></div>
                 <div id="clash-squad-tournaments" class="tournament-category"></div>
                 <div id="lone-wolf-tournaments" class="tournament-category"></div>
            </div>
            <div id="finance-section" class="section">
                 <h2 class="page-title">FFARENA FINANCE</h2>
                 <div id="finance-success" class="message success-message"></div>
                 <div id="finance-error" class="message error-message"></div>
                 <div class="content-card">
                    <h3>Add Money</h3>
                    <p class="info-text" style="background:var(--input-bg); border-radius:8px; padding:15px; text-align:center;">Send money to <strong>01852093429 (Bkash)</strong>. Then submit details.</p>
                    <form onsubmit="return false;" id="add-money-form"> <div class="form-field"><input type="text" id="transaction-id" placeholder="Transaction ID" required></div> <div class="form-field"><input type="number" id="add-amount" placeholder="Amount (BDT)" required></div> <button id="add-money-btn" class="btn btn-primary">Submit Request</button> </form>
                 </div>
                 <div class="content-card">
                    <h3>Withdraw</h3>
                    <form onsubmit="return false;" id="withdraw-form"> <div class="form-field"><input type="text" id="bkash-number" placeholder="Bkash Number" required></div> <div class="form-field"><input type="number" id="withdraw-amount" placeholder="Amount (BDT) (min 70 BDT)" required></div> <button id="withdraw-btn" class="btn btn-primary">Request Withdraw</button> </form>
                 </div>
                 <div class="content-card">
                    <h3>Transfer Balance</h3>
                    <form onsubmit="return false;" id="transfer-form"> <div class="form-field"><input type="text" id="transfer-username" placeholder="Recipient's Username" required></div> <div class="form-field"><input type="number" id="transfer-amount" placeholder="Amount (BDT) (min 30 BDT)" required></div> <button id="transfer-btn" class="btn btn-special">Transfer</button> </form>
                 </div>
                 <div class="content-card">
                    <h3>Transaction History</h3>
                    <div id="transaction-history-list"></div>
                 </div>
            </div>
         </div>
         <div class="bottom-nav">
            <div class="bottom-nav-inner"> <button id="nav-profile-btn"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>Profile</button> <button id="nav-tournament-btn" class="active"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2zM8 11H6V9h2v2zm0-3H6V6h2v2zm6 5h-4v-2h4v2zm0-3h-4V9h4v2zm0-3h-4V6h4v2zm4 5h-2v-2h2v2zm0-3h-2V9h2v2z"/></svg>Tournaments</button> <button id="nav-finance-btn"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2l-.01-12zM20 16H4V8h16v8zM12 15c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z"/></svg>Finance</button> </div>
         </div>
    </div>
</div>
    
<div class="modal-overlay" id="gamer-tag-modal-overlay"> 
    <div class="modal"> 
        <div class="modal-header">Enter GamerTags</div> 
        <div class="modal-body" id="gamer-tag-inputs"></div> 
        <div id="gamer-tag-error" class="message error-message" style="margin-top: 15px;"></div> 
        <div class="modal-actions"> 
            <button id="cancel-join-btn" class="btn cancel">Cancel</button> 
            <button id="confirm-join-btn" class="btn btn-primary">Confirm Join</button> 
        </div> 
    </div> 
</div>

<div class="modal-overlay" id="details-modal-overlay">
    <div class="modal">
        <div class="modal-header" id="details-modal-title">Tournament Details</div>
        <div class="modal-body" id="details-modal-content"></div>
        <div class="modal-actions">
            <button id="details-modal-close-btn" class="btn btn-primary">Close</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="player-list-modal-overlay">
    <div class="modal">
        <div class="modal-header">Gamertags</div>
        <div class="modal-body" id="player-list-modal-content"></div>
        <div class="modal-actions">
            <button id="player-list-modal-close-btn" class="btn btn-primary">Close</button>
        </div>
    </div>
</div>


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getDatabase, ref, set, onValue, runTransaction, get, push, update } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    // --- Firebase and Auth Initialization ---
    const firebaseConfig = {
      apiKey: "AIzaSyCGQIUYCFzdNZfx-KIjVZ435oeKDQdSeJk",
      authDomain: "ffarena-3305a.firebaseapp.com",
      databaseURL: "https://ffarena-3305a-default-rtdb.firebaseio.com",
      projectId: "ffarena-3305a",
      storageBucket: "ffarena-3305a.firebasestorage.app",
      messagingSenderId: "285029626101",
      appId: "1:285029626101:web:c4d8702618162f254a95bc",
      measurementId: "G-C7QVPB496S"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase();

    // --- Global Variables & DOM Elements ---
    const sections = document.querySelectorAll('.section');
    const navButtons = document.querySelectorAll('.bottom-nav button');
    let currentUserId = null;
    let countdownIntervals = {};

    // --- Core Functions ---
    function showMessage(id, msg) { const el = document.getElementById(id); if (el) { el.textContent = msg; el.style.display = 'block'; } }
    function hideMessage(id) { const el = document.getElementById(id); if (el) { el.style.display = 'none'; } }
    function showFlashMessage(id, msg, isError = false) {
        const el = document.getElementById(id);
        if (el) {
            el.textContent = msg;
            el.classList.toggle('success-message', !isError);
            el.classList.toggle('error-message', isError);
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 4000);
        }
    }
    
    function toggleForm(isLogin) {
        document.getElementById('login-form').classList.toggle('active', isLogin);
        document.getElementById('register-form').classList.toggle('active', !isLogin);
        document.getElementById('show-login-btn').classList.toggle('active', isLogin);
        document.getElementById('show-register-btn').classList.toggle('active', !isLogin);
        document.getElementById('auth-title').textContent = isLogin ? 'FFARENA LOGIN' : 'FFARENA REGISTER';
        hideMessage('auth-error');
    }

    function switchSection(targetId) {
        sections.forEach(s => s.classList.toggle('active', s.id === targetId));
        navButtons.forEach(b => b.classList.toggle('active', b.id.startsWith('nav-' + targetId.split('-')[0])));
        if (!currentUserId) return;
        if (targetId === 'tournament-section') loadTournaments(currentUserId);
        else if (targetId === 'profile-section') loadUserProfile(currentUserId);
        else if (targetId === 'finance-section') loadTransactionHistory(currentUserId);
    }

    // --- DATA LOADING FUNCTIONS ---
    function loadUserProfile(uid) {
        const userRef = ref(db, `users/${uid}`);
        onValue(userRef, (snapshot) => {
            if (!snapshot.exists()) return;
            const data = snapshot.val();
            document.getElementById('profile-username').textContent = data.username || 'N/A';
            document.getElementById('profile-email').textContent = data.email || 'N/A';
            document.getElementById('profile-balance').textContent = (data.balance || 0).toFixed(2);
            
            // <<< START: MODIFIED CODE >>>
            // 1. Check for a locally saved picture first.
            const localPic = localStorage.getItem('profilePic');
            if (localPic) {
                document.getElementById('profile-pic-img').src = localPic;
            } else {
                // 2. If not found locally, use the URL from Firebase DB.
                document.getElementById('profile-pic-img').src = data.profilePicUrl || "https://i.ibb.co/6yT4R45/default-avatar.png";
            }
            // <<< END: MODIFIED CODE >>>
        });
    }

    function startCountdown(elementId, startTime) {
        if (countdownIntervals[elementId]) clearInterval(countdownIntervals[elementId]);
        const countdownElement = document.getElementById(elementId);
        if (!countdownElement) return;
        const matchTime = new Date(startTime).getTime();
        const update = () => {
            const distance = matchTime - new Date().getTime();
            if (distance < 0) {
                clearInterval(countdownIntervals[elementId]);
                if(countdownElement.parentElement) countdownElement.parentElement.innerHTML = `<p class="match-started-text">Match Started</p>`;
                return;
            }
            const d = Math.floor(distance/(1000*60*60*24)), h = Math.floor((distance%(1000*60*60*24))/(1000*60*60)), m = Math.floor((distance%(1000*60*60))/(1000*60)), s = Math.floor((distance%(1000*60))/1000);
            countdownElement.innerHTML = `${d}d : ${h}h : ${m}m : ${s}s`;
        };
        update();
        countdownIntervals[elementId] = setInterval(update, 1000);
    }
    
    function loadTournaments(currentUserId) {
        const classicListEl = document.getElementById('classic-tournaments');
        const clashSquadListEl = document.getElementById('clash-squad-tournaments');
        const loneWolfListEl = document.getElementById('lone-wolf-tournaments');
        
        onValue(ref(db, 'tournaments'), (snapshot) => {
            classicListEl.innerHTML = ''; clashSquadListEl.innerHTML = ''; loneWolfListEl.innerHTML = '';
            Object.values(countdownIntervals).forEach(clearInterval);
            countdownIntervals = {};

            if (!snapshot.exists()) { classicListEl.innerHTML = '<p style="text-align:center;">No active tournaments.</p>'; return; }
            
            snapshot.forEach(childSnapshot => {
                const key = childSnapshot.key;
                const t = childSnapshot.val();

                const joinedPlayerCount = t.players ? Object.values(t.players).reduce((acc, p) => acc + (Array.isArray(p.gamerTags) ? p.gamerTags.length : 1), 0) : 0;
                const maxPlayers = t.maxPlayers || 1;
                const isFull = joinedPlayerCount >= maxPlayers;
                const hasStarted = t.startTime ? new Date(t.startTime).getTime() < new Date().getTime() : false;

                let hasAccess = false;
                if (t.players && currentUserId) {
                    if (t.players[currentUserId]) {
                        hasAccess = true;
                    } else {
                        for (const playerData of Object.values(t.players)) {
                            if (playerData.authorizedUsers && playerData.authorizedUsers.includes(currentUserId)) {
                                hasAccess = true;
                                break;
                            }
                        }
                    }
                }
                
                const progressPercentage = (joinedPlayerCount / maxPlayers) * 100;
                const prizeDetailsHtml = t.prizeDetails ? t.prizeDetails.replace(/\\n/g, '\n') : 'No prize details available.';
                
                let actionButtonHtml = hasAccess ? `<button class="btn btn-info room-id-btn" data-id="${key}">Room ID</button>` :
                                       (isFull || hasStarted) ? `<button class="btn" style="background-color:#5a6268; flex-grow:1" disabled>Full</button>` :
                                       `<button class="btn btn-success join-btn" data-id="${key}" data-fee="${t.entryFee}" data-players-per-team="${t.playersPerTeam || 1}">Join</button>`;

                const card = document.createElement('div');
                card.className = 'new-tournament-card';
                card.innerHTML = `
                    <div class="card-header" data-id="${key}">
                        <img src="${t.imageUrl || 'https://i.ibb.co/6yT4R45/default-avatar.png'}" alt="mode">
                        <div class="card-header-title">
                            <h3>${t.name}</h3>
                            <p>${(t.playersPerTeam || 1) > 1 ? `${t.playersPerTeam} vs ${t.playersPerTeam}` : 'Solo'} | ${t.startTime ? new Date(t.startTime).toLocaleTimeString('en-BD', { hour: 'numeric', minute: '2-digit'}) : 'TBD'}</p>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="details-grid">
                            <div class="detail-item"><p>TOTAL PRIZE</p><span>৳ ${t.totalPrize || 0}</span></div>
                            <div class="detail-item"><p>PER KILL</p><span>৳ ${t.perKillBonus || 0}</span></div>
                            <div class="detail-item"><p>ENTRY FEE</p><span>৳ ${t.entryFee || 0}</span></div>
                        </div>
                        <div class="sub-details-grid">
                             <div class="detail-item"><p>TYPE</p><span>${t.type || ((t.playersPerTeam||1) > 1 ? 'Squad' : 'Solo')}</span></div>
                             <div class="detail-item"><p>VERSION</p><span>${t.version || 'Mobile'}</span></div>
                             <div class="detail-item"><p>MAP</p><span>${t.map || 'Bermuda'}</span></div>
                        </div>
                        <div class="countdown-container">${!hasStarted && t.startTime ? `<div class="countdown" id="countdown-${key}"></div>` : '<p class="match-started-text">Match Started</p>'}</div>
                        <div class="player-progress-section view-players-btn" data-id="${key}">
                            <span class="player-count">${joinedPlayerCount} Joined</span>
                            <div class="progress-bar-container"><div class="progress-bar-fill" style="width: ${progressPercentage}%;"></div></div>
                            <span class="player-count">${Math.max(0, maxPlayers - joinedPlayerCount)} Left</span>
                        </div>
                    </div>
                    <div class="prize-list-details" id="prize-list-${key}">${prizeDetailsHtml}</div>
                    <div class="card-footer">
                        <button class="btn btn-info prize-list-btn" data-target="prize-list-${key}">Prize List</button>
                        ${actionButtonHtml}
                    </div>`;

                const category = t.category || 'classic';
                if(category === 'clash-squad') clashSquadListEl.appendChild(card);
                else if(category === 'lone-wolf') loneWolfListEl.appendChild(card);
                else classicListEl.appendChild(card);
                
                if (t.startTime && !hasStarted) startCountdown(`countdown-${key}`, t.startTime);
            });
            if(classicListEl.innerHTML === '') classicListEl.innerHTML = '<p style="text-align:center;">No Classic matches available.</p>';
            if(clashSquadListEl.innerHTML === '') clashSquadListEl.innerHTML = '<p style="text-align:center;">No Clash Squad matches available.</p>';
            if(loneWolfListEl.innerHTML === '') loneWolfListEl.innerHTML = '<p style="text-align:center;">No Lone Wolf matches available.</p>';
        });
    }

    async function loadTransactionHistory(userId) {
        const listEl = document.getElementById('transaction-history-list');
        listEl.innerHTML = '<p>Loading history...</p>';
        try {
            const [addMoneySnap, withdrawSnap, transfersSnap] = await Promise.all([
                get(ref(db, 'addMoneyRequests')),
                get(ref(db, 'withdrawRequests')),
                get(ref(db, 'transfers'))
            ]);

            let allTxs = [];

            if (addMoneySnap.exists()) {
                Object.entries(addMoneySnap.val()).forEach(([id, tx]) => {
                    if (tx && tx.userId === userId) { allTxs.push({ id, ...tx, type: 'Add Money' }); }
                });
            }

            if (withdrawSnap.exists()) {
                Object.entries(withdrawSnap.val()).forEach(([id, tx]) => {
                    if (tx && tx.userId === userId) { allTxs.push({ id, ...tx, type: 'Withdraw' }); }
                });
            }

            if (transfersSnap.exists()) {
                Object.entries(transfersSnap.val()).forEach(([id, tx]) => {
                    if (tx) { 
                        if (tx.senderId === userId) { allTxs.push({ id, ...tx, type: 'Sent' }); }
                        if (tx.recipientId === userId) { allTxs.push({ id, ...tx, type: 'Received' }); }
                    }
                });
            }

            allTxs.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            if (allTxs.length === 0) {
                listEl.innerHTML = '<p style="text-align:center;">No transaction history found.</p>';
                return;
            }
            
            listEl.innerHTML = '';
            allTxs.forEach(tx => {
                const timestamp = tx.timestamp ? new Date(tx.timestamp) : new Date();
                const date = timestamp.toLocaleString('en-BD', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                let typeDisplay, amountDisplay, amountClass;
                
                if (tx.type === 'Sent') {
                    typeDisplay = `Transfer to ${tx.recipientUsername || 'Unknown'}`;
                    amountDisplay = `-${tx.amount || 0} BDT`;
                    amountClass = 'Debit';
                } else if (tx.type === 'Received') {
                    typeDisplay = `Transfer from ${tx.senderUsername || 'Unknown'}`;
                    amountDisplay = `+${tx.amount || 0} BDT`;
                    amountClass = 'Credit';
                } else {
                    typeDisplay = tx.type;
                    const status = tx.status || 'Pending';
                    if (status === 'Approved') {
                        amountDisplay = `${tx.type === 'Add Money' ? '+' : '-'}${tx.amount || 0} BDT`;
                        amountClass = tx.type === 'Add Money' ? 'Credit' : 'Debit';
                    } else if (status === 'Rejected') {
                        amountDisplay = `Rejected`; amountClass = 'Rejected'; 
                    } else {
                        amountDisplay = status; amountClass = 'Pending';
                    }
                }
                const itemEl = document.createElement('div');
                itemEl.className = 'transaction-item';
                itemEl.innerHTML = `<div class="transaction-info"><p class="type">${typeDisplay}</p><p class="date">${date}</p></div><div class="transaction-amount ${amountClass}">${amountDisplay}</div>`;
                listEl.appendChild(itemEl);
            });
        } catch (error) {
            console.error("History Loading Error:", error);
            listEl.innerHTML = `<p style="color: var(--error-color); text-align:center;">Could not load history.</p>`;
        }
    }

    // --- MODAL & JOIN LOGIC ---
    function closeDetailsModal() { document.getElementById('details-modal-overlay').classList.remove('active'); }
    function closePlayerListModal() { document.getElementById('player-list-modal-overlay').classList.remove('active'); }

    async function showTournamentDetailsModal(tournamentId) {
        const modalOverlay = document.getElementById('details-modal-overlay');
        const modalTitleEl = document.getElementById('details-modal-title');
        const modalContentEl = document.getElementById('details-modal-content');

        modalTitleEl.textContent = 'Loading...';
        modalContentEl.innerHTML = '<p>Fetching tournament information...</p>';
        modalOverlay.classList.add('active');

        try {
            const tournamentSnap = await get(ref(db, `tournaments/${tournamentId}`));
            if (!tournamentSnap.exists()) throw new Error("Tournament not found.");
            const t = tournamentSnap.val();
            
            modalTitleEl.textContent = t.name;
            let roomDetailsHtml = ``;

            const players = t.players || {};
            let hasAccess = false;
            if(currentUserId && players[currentUserId]){
                hasAccess = true;
            } else if (currentUserId) {
                for (const playerData of Object.values(players)) {
                    if (playerData.authorizedUsers && playerData.authorizedUsers.includes(currentUserId)) {
                        hasAccess = true;
                        break;
                    }
                }
            }

            if(hasAccess){
                roomDetailsHtml = `
                <div class="details-modal-section">
                    <h4>Room Details</h4>
                    <p><strong>Room ID:</strong> ${t.roomID || 'Announced Soon'}</p>
                    <p><strong>Password:</strong> ${t.roomPass || 'Announced Soon'}</p>
                </div>
                `;
            }

            modalContentEl.innerHTML = `
                <div class="details-modal-section">
                    <h4>Key Information</h4>
                    <p><strong>Entry Fee:</strong> ${t.entryFee} BDT</p>
                    <p><strong>Start Time:</strong> ${t.startTime ? new Date(t.startTime).toLocaleString('en-US', { dateStyle: 'long', timeStyle: 'short' }) : 'TBD'}</p>
                </div>
                ${roomDetailsHtml}
                <div class="details-modal-section">
                    <h4>Details & Rules</h4>
                    <p style="white-space: pre-wrap; word-wrap: break-word;">${t.detailsAndRules || 'No specific rules provided.'}</p>
                </div>
            `;
        } catch (error) {
            modalContentEl.innerHTML = `<p style="color: var(--error-color);">Could not load details: ${error.message}</p>`;
        }
    }

    async function showPlayerListModal(tournamentId) {
        const modalOverlay = document.getElementById('player-list-modal-overlay');
        const modalContentEl = document.getElementById('player-list-modal-content');
        modalContentEl.innerHTML = '<p>Loading players...</p>';
        modalOverlay.classList.add('active');
        try {
            const playersSnap = await get(ref(db, `tournaments/${tournamentId}/players`));
            if (!playersSnap.exists() || Object.keys(playersSnap.val()).length === 0) {
                modalContentEl.innerHTML = '<p>No players have joined yet.</p>';
                return;
            }
            modalContentEl.innerHTML = '';
            Object.values(playersSnap.val()).forEach(player => {
                const playerEl = document.createElement('p');
                const tags = Array.isArray(player.gamerTags) ? player.gamerTags.join(' • ') : (player.gamerTag || 'Unknown Gamertag');
                playerEl.textContent = tags;
                modalContentEl.appendChild(playerEl);
            });
        } catch (error) { modalContentEl.innerHTML = `<p style="color: var(--error-color);">Could not load player list.</p>`; }
    }

    function showJoinTournamentModal(tournamentId, entryFee, playersPerTeam) {
        const modalOverlay = document.getElementById('gamer-tag-modal-overlay');
        const gamerTagInputsContainer = document.getElementById('gamer-tag-inputs');
        gamerTagInputsContainer.innerHTML = '';
        hideMessage('gamer-tag-error');

        let inputHtml = '';
        for (let i = 0; i < playersPerTeam; i++) {
            inputHtml += `<div class="player-input-group" style="background: var(--input-bg); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <div class="form-field" style="margin-bottom: 12px;">
                    <label for="gamer-tag-input-${i}">Gamer Tag (Player ${i + 1}):</label>
                    <input type="text" id="gamer-tag-input-${i}" class="gamer-tag-input-field" placeholder="Enter Gamer Tag" required>
                </div>
                ${playersPerTeam > 1 ? `<div class="form-field" style="margin-bottom: 0;">
                    <label for="username-input-${i}">Enter Username (Optional):</label>
                    <input type="text" id="username-input-${i}" class="username-input-field" placeholder="Share room access with user">
                </div>` : ''}
            </div>`;
        }
        gamerTagInputsContainer.innerHTML = inputHtml;
        modalOverlay.classList.add('active');

        document.getElementById('confirm-join-btn').onclick = async () => {
            const gamerTagInputs = [...document.querySelectorAll('.gamer-tag-input-field')].map(i => i.value.trim());
            if (gamerTagInputs.some(tag => !tag)) {
                return showMessage('gamer-tag-error', 'All Gamer Tag fields must be filled.');
            }

            const totalFee = entryFee * playersPerTeam;
            const collectedUsernames = [...document.querySelectorAll('.username-input-field')].map(i => i.value.trim().toLowerCase()).filter(Boolean);
            
            let authorizedUserIds = [currentUserId];
            if (collectedUsernames.length > 0) {
                try {
                    const allUsersSnap = await get(ref(db, 'users'));
                    if (!allUsersSnap.exists()) throw new Error("Could not verify users.");
                    const usernameToUidMap = {};
                    Object.entries(allUsersSnap.val()).forEach(([uid, userData]) => {
                        if (userData?.username) usernameToUidMap[userData.username.toLowerCase()] = uid;
                    });
                    for (const username of collectedUsernames) {
                        const foundUid = usernameToUidMap[username];
                        if (foundUid && !authorizedUserIds.includes(foundUid)) authorizedUserIds.push(foundUid);
                        else if (!foundUid) throw new Error(`User "${username}" not found.`);
                    }
                } catch(error) { return showMessage('gamer-tag-error', error.message); }
            }

            try {
                await runTransaction(ref(db, `users/${currentUserId}/balance`), (currentBalance) => {
                    if ((currentBalance || 0) >= totalFee) return currentBalance - totalFee;
                    else throw new Error("Insufficient balance.");
                });
                
                await set(ref(db, `tournaments/${tournamentId}/players/${currentUserId}`), {
                    gamerTags: gamerTagInputs,
                    joinedAt: Date.now(),
                    authorizedUsers: authorizedUserIds
                });

                showFlashMessage('tournament-success', 'Successfully joined!');
                modalOverlay.classList.remove('active');
            } catch (error) {
                showMessage('gamer-tag-error', error.message.includes("Insufficient balance") ? 'Insufficient balance.' : 'Failed to join. Try again.');
            }
        };
        document.getElementById('cancel-join-btn').onclick = () => modalOverlay.classList.remove('active');
    }

    // --- FINANCE TRANSACTION HANDLERS ---
    async function handleAddMoney() { /* Unchanged */ }
    async function handleWithdraw() { /* Unchanged */ }
    async function handleTransfer() { /* Unchanged */ }

    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('show-login-btn').addEventListener('click', () => toggleForm(true));
        document.getElementById('show-register-btn').addEventListener('click', () => toggleForm(false));

        document.getElementById('login-btn').addEventListener('click', () => {
             const email = document.getElementById('login-email').value;
             const password = document.getElementById('login-password').value;
             if (!email || !password) return showMessage('auth-error', 'Enter email and password.');
             signInWithEmailAndPassword(auth, email, password).catch(err => showMessage('auth-error', err.message));
        });

        document.getElementById('register-btn').addEventListener('click', () => {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const username = document.getElementById('register-username').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;

            if (!email || !password || !username) return showMessage('auth-error', 'Please fill all fields.');
            if (password !== confirmPassword) return showMessage('auth-error', "Passwords do not match.");
            
            createUserWithEmailAndPassword(auth, email, password)
                .then(cred => set(ref(db, 'users/' + cred.user.uid), { 
                    username, email, balance: 0, profilePicUrl: "https://i.ibb.co/6yT4R45/default-avatar.png"
                }))
                .then(() => toggleForm(true))
                .catch(err => showMessage('auth-error', err.message));
        });

        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetId = button.id.replace('nav-', '').replace('-btn', '') + '-section';
                switchSection(targetId);
            });
        });
        
        // <<< START: MODIFIED CODE >>>
        document.getElementById('profile-pic-upload').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();

            reader.onload = function(e) {
                const imageDataUrl = e.target.result;
                // Save the image data URL to local storage
                localStorage.setItem('profilePic', imageDataUrl);
                // Immediately display the new image
                document.getElementById('profile-pic-img').src = imageDataUrl;
                // Show a success message
                showFlashMessage('profile-info-success', 'Profile picture updated locally!');
            };

            reader.readAsDataURL(file); // Read the file as a a Data URL (base64)
        });
        // <<< END: MODIFIED CODE >>>

        document.querySelector('.tournament-nav').addEventListener('click', (e) => {
            if (e.target.classList.contains('nav-tab')) {
                document.querySelectorAll('.tournament-nav .nav-tab, .tournament-category').forEach(el => el.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById(e.target.dataset.target).classList.add('active');
            }
        });

        document.getElementById('tournament-section').addEventListener('click', async e => {
            const cardHeader = e.target.closest('.card-header');
            const joinBtn = e.target.closest('.join-btn');
            const prizeListBtn = e.target.closest('.prize-list-btn');
            const roomIdBtn = e.target.closest('.room-id-btn');
            const viewPlayersBtn = e.target.closest('.view-players-btn');

            if (prizeListBtn) {
                const targetEl = document.getElementById(prizeListBtn.dataset.target);
                if(targetEl) targetEl.style.display = targetEl.style.display === 'block' ? 'none' : 'block';
            } else if (joinBtn) {
                const { id, fee, playersPerTeam } = joinBtn.dataset;
                showJoinTournamentModal(id, parseFloat(fee), parseInt(playersPerTeam));
            } else if (cardHeader || roomIdBtn) { // Clicking the entire header or room id button
                const tournamentId = (cardHeader || roomIdBtn).dataset.id;
                showTournamentDetailsModal(tournamentId);
            } else if (viewPlayersBtn) {
                const tournamentId = viewPlayersBtn.dataset.id;
                showPlayerListModal(tournamentId);
            }
        });
        
        document.getElementById('details-modal-close-btn').addEventListener('click', closeDetailsModal);
        document.getElementById('details-modal-overlay').addEventListener('click', (e) => { if (e.target.id === 'details-modal-overlay') closeDetailsModal(); });
        document.getElementById('player-list-modal-close-btn').addEventListener('click', closePlayerListModal);
        document.getElementById('player-list-modal-overlay').addEventListener('click', (e) => { if (e.target.id === 'player-list-modal-overlay') closePlayerListModal(); });

        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('auth-section').classList.remove('active');
                document.getElementById('app-section').classList.add('active');
                document.getElementById('logout-btn').onclick = () => {
                    signOut(auth).then(() => {
                        // Optional: Clear the local storage picture on logout
                        // localStorage.removeItem('profilePic'); 
                        location.reload();
                    });
                };
                document.getElementById('add-money-btn').onclick = handleAddMoney;
                document.getElementById('withdraw-btn').onclick = handleWithdraw;
                document.getElementById('transfer-btn').onclick = handleTransfer;
                switchSection('tournament-section');
            } else {
                currentUserId = null;
                Object.values(countdownIntervals).forEach(clearInterval);
                countdownIntervals = {};
                document.getElementById('auth-section').classList.add('active');
                document.getElementById('app-section').classList.remove('active');
                toggleForm(true); 
            }
        });
    });
</script>
</body>
</html>